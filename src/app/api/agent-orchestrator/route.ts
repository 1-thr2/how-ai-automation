import { NextRequest, NextResponse } from 'next/server';
import { callOpenAI } from '@/lib/openai';
import { AutomationData } from '@/app/types/automation';
import { handleError, handleApiError } from '@/lib/error-handler';
import { saveAutomationRequest } from '@/lib/supabase';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ğŸ¯ í˜„ì‹¤ì  ì ˆì¶©ì•ˆ: 3ë‹¨ê³„ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€ + ë¶€ë¶„ ìµœì í™”)
export async function POST(req: Request) {
  let userInput = '';
  let followupAnswers = {};
  let startTime = Date.now();
  
  try {
    const requestData = await req.json();
    userInput = requestData.userInput;
    followupAnswers = requestData.followupAnswers;
    
    console.log('ğŸš€ [í•˜ì´ë¸Œë¦¬ë“œ] 3ë‹¨ê³„ ìë™í™” ìƒì„± ì‹œì‘');
    console.log('ğŸ“ ì‚¬ìš©ì ì…ë ¥:', userInput);
    console.log('ğŸ“‹ í›„ì† ë‹µë³€:', followupAnswers);

    startTime = Date.now();
    let allCards = [];

    // ğŸ”„ 1ë‹¨ê³„: ë‹ˆì¦ˆ ë¶„ì„ + í”Œë¡œìš° ìƒì„± (gpt-4o-2024-11-20 - í’ˆì§ˆ ìš°ì„ )
    console.log('[1ë‹¨ê³„] ë‹ˆì¦ˆ ë¶„ì„ + í”Œë¡œìš° ìƒì„± (gpt-4o-2024-11-20 - í’ˆì§ˆ ìš°ì„ )');
    const stage1Response = await openai.chat.completions.create({
      model: 'gpt-4o-2024-11-20',
      messages: [
        {
          role: 'system',
          content: `ë‹¹ì‹ ì€ 2025ë…„ ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œì„ ê³ ë ¤í•œ ìµœì  ìë™í™” ìˆ˜ì¤€ì„ ì¶”ì²œí•˜ì„¸ìš”.

# í•µì‹¬ ì›ì¹™: ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ ê¸°ì¤€ìœ¼ë¡œ AIê°€ ì¶”ì²œ

## ìë™í™” ìˆ˜ì¤€ ë¶„ì„ ê¸°ì¤€:
1. **ë¹ˆë„ ë¶„ì„**: ì¼íšŒì„± vs ì£¼ê¸°ì  vs ì‹¤ì‹œê°„
2. **ë°ì´í„°ëŸ‰**: ì†ŒëŸ‰ vs ì¤‘ê°„ vs ëŒ€ëŸ‰
3. **ë³µì¡ë„**: ë‹¨ìˆœ vs ì¤‘ê°„ vs ë³µì¡
4. **íŒ€ ê·œëª¨**: ê°œì¸ vs íŒ€ vs ì¡°ì§
5. **ê¸°ìˆ  ìˆ˜ì¤€**: ì´ˆë³´ vs ì¤‘ê¸‰ vs ê³ ê¸‰

## ìë™í™” ìˆ˜ì¤€ë³„ íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ:

### ğŸŸ¢ ìˆ˜ë™ ì²˜ë¦¬ (ROI ì¸¡ì • ë‹¨ê³„)
- **íˆ¬ì…**: 30ë¶„-1ì‹œê°„/íšŒ
- **ì ìš©**: ì›” 1-2íšŒ or ì¼íšŒì„± or ë°ì´í„° ì†ŒëŸ‰
- **ì¥ì **: ì¦‰ì‹œ ì‹œì‘, í•™ìŠµ ë¹„ìš© ì—†ìŒ
- **ë‹¨ì **: ë°˜ë³µ ì‹œ ë¹„íš¨ìœ¨

### ğŸŸ¡ ë°˜ìë™í™” (íš¨ìœ¨ì„± ì¦ëŒ€)
- **íˆ¬ì…**: ì„¤ì • 1-2ì‹œê°„ + ì£¼ 5-10ë¶„ ê´€ë¦¬
- **ì ìš©**: ì£¼ 1íšŒ ì´ìƒ or íŒ¨í„´ ë°˜ë³µ or ì¤‘ê°„ ë°ì´í„°ëŸ‰
- **ì¥ì **: 80% ì‹œê°„ ì ˆì•½, ì•ˆì •ì„±
- **ë‹¨ì **: ì´ˆê¸° ì„¤ì • í•„ìš”

### ğŸ”´ ì™„ì „ìë™í™” (ìŠ¤ì¼€ì¼ë§)
- **íˆ¬ì…**: ì„¤ì • 3-5ì‹œê°„ + ì›” 10-20ë¶„ ê´€ë¦¬
- **ì ìš©**: ì¼ì¼ ë°˜ë³µ or ëŒ€ëŸ‰ ë°ì´í„° or íŒ€ ê³µìœ 
- **ì¥ì **: 95% ì‹œê°„ ì ˆì•½, í™•ì¥ì„±
- **ë‹¨ì **: ë†’ì€ ì´ˆê¸° íˆ¬ì

# ë°˜ë“œì‹œ JSON í˜•íƒœë¡œ ì‘ë‹µ:
{
  "cards": [
    {
      "type": "needs_analysis",
      "title": "ğŸ¯ ì§„ì§œ ë‹ˆì¦ˆ ë°œê²¬",
      "surfaceRequest": "ì‚¬ìš©ìê°€ ë§í•œ ê²ƒ",
      "realNeed": "ì‹¤ì œë¡œ í•„ìš”í•œ ê²ƒ",
      "recommendedLevel": "ìˆ˜ë™/ë°˜ìë™/ì™„ì „ìë™",
      "expectedBenefit": "ì˜ˆìƒ íš¨ê³¼ (ì‹œê°„ ì ˆì•½, ì •í™•ë„ í–¥ìƒ ë“±)",
      "investmentRequired": "í•„ìš”í•œ íˆ¬ì… (ì‹œê°„, í•™ìŠµ ë“±)",
      "whyThisLevel": "ì´ ìˆ˜ì¤€ì„ ì¶”ì²œí•˜ëŠ” ì´ìœ "
    },
    {
      "type": "flow",
      "title": "ğŸš€ ì¶”ì²œ ìë™í™” í”Œë¡œìš°",
      "subtitle": "íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ ìµœì í™”ëœ ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íš",
      "automationLevel": "ì¶”ì²œëœ ìë™í™” ìˆ˜ì¤€",
      "expectedROI": "ì˜ˆìƒ íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ",
      "steps": [
        {
          "id": "1",
          "icon": "ğŸ”§",
          "title": "êµ¬ì²´ì  ê²°ê³¼ ì¤‘ì‹¬ ë‹¨ê³„ëª…",
          "subtitle": "ì‚¬ìš©ìê°€ ëŠë‚„ í¸ë¦¬í•¨",
          "duration": "ì˜ˆìƒ ì‹œê°„",
          "automationType": "ìˆ˜ë™/ë°˜ìë™/ì™„ì „ìë™",
          "inputData": "ì´ ë‹¨ê³„ì—ì„œ ì²˜ë¦¬í•  ì…ë ¥ ë°ì´í„°",
          "outputData": "ì´ ë‹¨ê³„ì—ì„œ ìƒì„±ë˜ëŠ” êµ¬ì²´ì  ê²°ê³¼ë¬¼ (íŒŒì¼ëª…, URL, ë°ì´í„° í˜•íƒœ)",
          "nextStepConnection": "ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ ê²°ê³¼ë¬¼ì„ ì–´ë–»ê²Œ í™œìš©í•˜ëŠ”ì§€",
          "toolRecommendation": {
            "primary": "ìµœì  íš¨ìœ¨ì„± ìš°ì„  + í›„ì†ë‹µë³€ ê¸°ë°˜ ìµœì  ë„êµ¬",
            "reason": "ìµœì  íš¨ìœ¨ì„± + í†µí•© ì›Œí¬í”Œë¡œìš° + ì‚¬ìš©ì ì í•©ì„±",
            "alternatives": ["ê°„ë‹¨í•œ ëŒ€ì•ˆ 1-2ê°œ"],
            "whyNotOthers": "ë‹¤ë¥¸ ë°©ë²•ë“¤ì„ ì•ˆ ì¶”ì²œí•˜ëŠ” ì´ìœ "
          }
        },
        {
          "id": "2",
          "icon": "ğŸ“Š",
          "title": "ë‘ ë²ˆì§¸ ë‹¨ê³„ëª…",
          "subtitle": "ì‚¬ìš©ìê°€ ëŠë‚„ í¸ë¦¬í•¨",
          "duration": "ì˜ˆìƒ ì‹œê°„",
          "automationType": "ìˆ˜ë™/ë°˜ìë™/ì™„ì „ìë™",
          "inputData": "1ë‹¨ê³„ì—ì„œ ìƒì„±ëœ êµ¬ì²´ì  ê²°ê³¼ë¬¼",
          "outputData": "ì´ ë‹¨ê³„ì—ì„œ ìƒì„±ë˜ëŠ” êµ¬ì²´ì  ê²°ê³¼ë¬¼",
          "nextStepConnection": "3ë‹¨ê³„ì—ì„œ ì´ ê²°ê³¼ë¬¼ì„ ì–´ë–»ê²Œ í™œìš©í•˜ëŠ”ì§€"
        },
        {
          "id": "3",
          "icon": "ğŸ¯",
          "title": "ì„¸ ë²ˆì§¸ ë‹¨ê³„ëª…",
          "subtitle": "ì‚¬ìš©ìê°€ ëŠë‚„ í¸ë¦¬í•¨",
          "duration": "ì˜ˆìƒ ì‹œê°„",
          "automationType": "ìˆ˜ë™/ë°˜ìë™/ì™„ì „ìë™",
          "inputData": "2ë‹¨ê³„ì—ì„œ ìƒì„±ëœ êµ¬ì²´ì  ê²°ê³¼ë¬¼",
          "outputData": "ìµœì¢… ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ê²°ê³¼ë¬¼",
          "nextStepConnection": "ìµœì¢… ëª©í‘œ ì™„ì„±"
        }
      ]
    }
  ]
}`
        },
        {
          role: 'user',
          content: `ì‚¬ìš©ì ìš”ì²­: "${userInput}"
ì‚¬ìš©ì í›„ì†ë‹µë³€: ${JSON.stringify(followupAnswers || {})}

# ğŸ¯ ì§„ì§œ ë‹ˆì¦ˆ ë°œêµ´ ë° wow ê²½í—˜ ì„¤ê³„

## í•µì‹¬ ì›ì¹™: í›„ì†ë‹µë³€ìœ¼ë¡œ ìˆ¨ì€ ìš•ë§ íŒŒì•…
í›„ì†ë‹µë³€ì€ í‘œë©´ì  ìš”ì²­ ë’¤ì— ìˆ¨ì€ ì§„ì§œ ë‹ˆì¦ˆë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤:

**ì˜ˆì‹œ ë¶„ì„**:
- í‘œë©´ ìš”ì²­: "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì‹œê°í™”"
- í›„ì†ë‹µë³€: {data_source: 'ìˆ˜ë™ ì…ë ¥', success_criteria: 'ì‹œê°„ ì ˆì•½'}
- **ì§„ì§œ ë‹ˆì¦ˆ**: ë§¤ë²ˆ ìˆ˜ë™ìœ¼ë¡œ ì°¨íŠ¸ ë§Œë“œëŠ” ê²Œ ë²ˆê±°ë¡œì›Œì„œ â†’ ìë™í™”ëœ ëŒ€ì‹œë³´ë“œë¡œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì‹¶ìŒ
- **wow í¬ì¸íŠ¸**: ë‹¨ìˆœ ì°¨íŠ¸ê°€ ì•„ë‹ˆë¼ "ë°ì´í„° ë³€í™” ì‹œ ìë™ ì•Œë¦¼ + íŠ¸ë Œë“œ ë¶„ì„ + íŒ€ ê³µìœ "ê¹Œì§€

## ë‹ˆì¦ˆ ë°œêµ´ ì§ˆë¬¸ë“¤:
1. **ì™œ ì´ê±¸ ì›í•˜ëŠ”ê°€?** (ì§„ì§œ ëª©ì )
2. **ëˆ„êµ¬ë¥¼ ìœ„í•œ ê²ƒì¸ê°€?** (ì´í•´ê´€ê³„ì)
3. **ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€?** (ì‚¬ìš© ë§¥ë½)
4. **ë¬´ì—‡ì´ ë¶ˆí¸í•œê°€?** (í˜„ì¬ ë¬¸ì œì )
5. **ì–´ë–¤ ê²°ê³¼ë¥¼ ì›í•˜ëŠ”ê°€?** (ê¸°ëŒ€ íš¨ê³¼)

## í›„ì†ë‹µë³€ â†’ ë‹ˆì¦ˆ ë§¤í•‘:
- data_source: 'ìˆ˜ë™ ì…ë ¥' â†’ ë°˜ë³µ ì‘ì—… ìë™í™” ìš•êµ¬
- current_workflow: 'ë¶„ì„í•˜ì§€ ì•ŠìŒ' â†’ ì¸ì‚¬ì´íŠ¸ ë„ì¶œ ìš•êµ¬
- success_criteria: 'ì‹œê°„ ì ˆì•½' â†’ íš¨ìœ¨ì„± + ë” ì¤‘ìš”í•œ ì¼ì— ì§‘ì¤‘ ìš•êµ¬

## wow ê²½í—˜ ì„¤ê³„:
í‘œë©´ì  ìš”ì²­ì„ **10ë°° ë” ê°€ì¹˜ìˆëŠ” ì‹œìŠ¤í…œ**ìœ¼ë¡œ í™•ì¥:
- ë‹¨ìˆœ ì°¨íŠ¸ â†’ ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ + ìë™ ì•Œë¦¼
- ì¼íšŒì„± ë¶„ì„ â†’ ì§€ì†ì  ëª¨ë‹ˆí„°ë§ + íŠ¸ë Œë“œ ì˜ˆì¸¡
- ê°œì¸ ì‚¬ìš© â†’ íŒ€ í˜‘ì—… + ì˜ì‚¬ê²°ì • ì§€ì›

## ğŸš¨ ë‹¨ê³„ ì„¤ê³„ ì›ì¹™ (í•„ìˆ˜):
- **í•˜ë‚˜ì˜ í†µí•© í”Œë«í¼**: ëª¨ë“  ë‹¨ê³„ê°€ í•˜ë‚˜ì˜ ìë™í™” í”Œë«í¼(Zapier, Make.com ë“±)ì—ì„œ ì—°ê²°ëœ ì›Œí¬í”Œë¡œìš° (ê°œë³„ ë¶„ë¦¬ ê¸ˆì§€)
- **ì‹¤ì œ ë°ì´í„° ì—°ê²°**: 1ë‹¨ê³„ ì¶œë ¥ â†’ 2ë‹¨ê³„ ì…ë ¥ â†’ 3ë‹¨ê³„ ì…ë ¥ì˜ êµ¬ì²´ì  ë°ì´í„° íë¦„
- **í•˜ë‚˜ì˜ íŠ¸ë¦¬ê±°**: ì „ì²´ ìë™í™”ê°€ í•˜ë‚˜ì˜ ì´ë²¤íŠ¸ë¡œ ì‹œì‘ë˜ì–´ ëê¹Œì§€ ì—°ê²°
- **ìµœì  íš¨ìœ¨ì„±**: ê°€ì¥ ë¹ ë¥´ê³  ì‰¬ìš´ ë°©ë²• ìš°ì„  (AI ë„êµ¬ê°€ ë” íš¨ìœ¨ì ì´ë©´ AI ë„êµ¬ ì„ íƒ)
- **ë‹¨ê³„ëª…**: ì‚¬ìš©ìê°€ ëŠë‚„ ê°€ì¹˜ ì¤‘ì‹¬ (ê¸°ìˆ ìš©ì–´ ê¸ˆì§€)
- **ë‚´ìš©**: í›„ì†ë‹µë³€ì˜ ë§¥ë½ì„ ê¹Šì´ ë°˜ì˜

## ğŸ”— **ì—°ê²°ëœ ìë™í™” ì„¤ê³„ í•„ìˆ˜ì‚¬í•­**:
- âŒ ê¸ˆì§€: "ê°œë³„ Zapier 3ê°œ ë§Œë“¤ê¸°", "ë”°ë¡œë”°ë¡œ ì„¤ì •í•˜ê¸°"
- âœ… í•„ìˆ˜: "í•˜ë‚˜ì˜ Zapierì—ì„œ ë‹¨ê³„ë³„ ì—°ê²°", "ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬"
- âœ… ì˜ˆì‹œ: "1ë‹¨ê³„ì—ì„œ ìˆ˜ì§‘ëœ ë°ì´í„° â†’ 2ë‹¨ê³„ AI ë¶„ì„ â†’ 3ë‹¨ê³„ ìŠ¬ë™ ì „ì†¡ (ëª¨ë‘ í•˜ë‚˜ì˜ ì›Œí¬í”Œë¡œìš°)"

## ğŸ¯ ê°œì¸ ë§ì¶¤í˜• ìµœì  ì†”ë£¨ì…˜ ì„ íƒ:
í›„ì†ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ **ì´ ì‚¬ìš©ìì—ê²Œ ê°€ì¥ ì í•©í•œ í•˜ë‚˜ì˜ ë°©ë²•**ì„ ì„ íƒí•˜ì„¸ìš”:

### ğŸ” **ì‚¬ìš©ì ë¶„ì„ ê¸°ì¤€**:
- **ê¸°ìˆ  ìˆ˜ì¤€**: í›„ì†ë‹µë³€ì—ì„œ ë“œëŸ¬ë‚˜ëŠ” ê¸°ìˆ ì  ì¹œìˆ™ë„
- **í˜„ì¬ ë„êµ¬**: ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ ê¸°ì¡´ ë„êµ¬ë“¤
- **ëª©í‘œ**: ì‹œê°„ ì ˆì•½ vs í’ˆì§ˆ í–¥ìƒ vs ì™„ì „ ìë™í™”
- **í™˜ê²½**: ê°œì¸ vs íŒ€ vs ê¸°ì—…

### ğŸ› ï¸ **ì„ íƒ ê°€ëŠ¥í•œ ì ‘ê·¼ë²•ë“¤** (íš¨ìœ¨ì„± ìš°ì„ ìˆœìœ„):
- **ğŸ† AI ë„êµ¬ ìš°ì„ **: ë¹ ë¥´ê³  ì‰¬ìš´ AI ë„êµ¬ (ChatGPT, Claude, Zapier AI, Make.com AI)
- **ğŸ“± ì‰¬ìš´ ë°©ë²•**: ê¸°ì¡´ ë„êµ¬ í™œìš© (Notion AI, êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤)
- **ğŸ”§ ì¤‘ê°„ ë°©ë²•**: í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ + ê°„ë‹¨í•œ ìë™í™”
- **ğŸ’» ê³ ê¸‰ ë°©ë²•**: ê°œë°œ/API ì—°ë™ (í•„ìš”ì‹œì—ë§Œ)
- **ğŸŒ íŠ¹í™” ë°©ë²•**: í•œêµ­ ë„êµ¬, ê¸°ì—… í™˜ê²½ ë§ì¶¤

### ğŸ“‹ **ì„ íƒ ê¸°ì¤€** (ìš°ì„ ìˆœìœ„ ìˆœ):
1. **ìµœì  íš¨ìœ¨ì„±**: ê°€ì¥ ë¹ ë¥´ê³  ì‰¬ìš´ ë°©ë²•ì¸ì§€ (AI vs ìˆ˜ë™ vs ì½”ë”©)
2. **í†µí•© ì›Œí¬í”Œë¡œìš°**: í•˜ë‚˜ë¡œ ì—°ê²°ëœ ì™„ì „í•œ ì‹œìŠ¤í…œ êµ¬ì„± ê°€ëŠ¥ì„±
3. **í›„ì†ë‹µë³€ ì í•©ì„±**: ì‚¬ìš©ì ì„±í–¥ê³¼ í™˜ê²½ì— ë§ëŠ”ì§€
4. **ì‹¤í–‰ ê°€ëŠ¥ì„±**: ê°€ì¥ íš¨ê³¼ì ì´ë©´ì„œ ì‹¤í˜„ ê°€ëŠ¥í•œì§€

**ê²°ê³¼**: ì—¬ëŸ¬ ë°©ë²•ì„ ë‚˜ì—´í•˜ì§€ ë§ê³ , **ì´ ì‚¬ìš©ìì—ê²Œ ë”± ë§ëŠ” í•˜ë‚˜ì˜ ìµœì  ì†”ë£¨ì…˜**ì„ ì œì‹œ`
        }
      ],
      max_tokens: 2000,
      temperature: 0.7
    });

    // 1ë‹¨ê³„ ê²°ê³¼ íŒŒì‹±
    const stage1Content = stage1Response.choices[0]?.message?.content;
    let stage1Cards: any[] = [];
    try {
      if (stage1Content) {
        const jsonMatch = stage1Content.match(/```json\s*([\s\S]*?)\s*```/);
        const jsonContent = jsonMatch ? jsonMatch[1] : stage1Content;
        const parsed = JSON.parse(jsonContent);
        stage1Cards = parsed.cards || [];
        allCards.push(...stage1Cards);
        console.log(`[1ë‹¨ê³„] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${stage1Cards.length}`);
      }
    } catch (error) {
      console.error('[1ë‹¨ê³„] íŒŒì‹± ì˜¤ë¥˜:', error);
    }

    // í”Œë¡œìš°ì—ì„œ ë‹¨ê³„ ì¶”ì¶œ
    const flowCard = stage1Cards.find((card: any) => card.type === 'flow');
    const steps = flowCard?.steps || [];
    console.log(`[2ë‹¨ê³„] ì‹œì‘ - ${steps.length}ê°œ ë‹¨ê³„ì— ëŒ€í•œ ìƒì„¸ ê°€ì´ë“œ ìƒì„±`);
    console.log(`[2ë‹¨ê³„] ìƒì„±ëœ ë‹¨ê³„ë“¤:`, steps.map((s: any) => `${s.id}. ${s.title}`));

    // ğŸ”„ 2ë‹¨ê³„: ê° ë‹¨ê³„ë³„ ìƒì„¸ ê°€ì´ë“œ ìƒì„± (gpt-4o-2024-11-20 - ìµœê³  í’ˆì§ˆ)
    const guideCards = [];
    
    // 1ë‹¨ê³„ì™€ 2ë‹¨ê³„ ì‚¬ì´ RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•œ ë”œë ˆì´
    console.log(`[2ë‹¨ê³„] 1ë‹¨ê³„ ì™„ë£Œ í›„ RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸°...`);
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    for (let i = 0; i < steps.length; i++) {
      const step = steps[i];
      console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ê°€ì´ë“œ ìƒì„±: ${step.title} (stepId: ${step.id})`);
      
      // RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸° (ê¸°ì¡´ 2ì´ˆ â†’ 1ì´ˆ ìµœì í™”)
      if (i > 0) {
        console.log(`[2ë‹¨ê³„] RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸°...`);
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      // ì´ì „ ë‹¨ê³„ë“¤ì˜ ê²°ê³¼ë¬¼ ìˆ˜ì§‘
      const previousSteps = steps.slice(0, i);
      const previousGuides = guideCards.filter(card => 
        previousSteps.some((prevStep: any) => prevStep.id === card.stepId)
      );

      try {
        const guideResponse = await openai.chat.completions.create({
          model: 'gpt-4o-2024-11-20', // ìµœê³  í’ˆì§ˆ ëª¨ë¸
          messages: [
            {
              role: 'system',
              content: `ë‹¹ì‹ ì€ ì»´í“¨í„° ì™•ì´ˆë³´ë„ 100% ë”°ë¼í•  ìˆ˜ ìˆëŠ” ì´ˆê·¹ìƒì„¸ ìë™í™” ê°€ì´ë“œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ğŸš¨ **ì ˆëŒ€ ì›ì¹™**: 
1. ì˜¤ì§ JSON í˜•íƒœë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”
2. ëª¨ë“  ë‹¨ê³„ëŠ” "1. ë¸Œë¼ìš°ì € ì—´ê¸° â†’ 2. ì£¼ì†Œ ì…ë ¥ â†’ 3. ë²„íŠ¼ í´ë¦­" ìˆ˜ì¤€ì˜ ë””í…Œì¼
3. API, í† í°, íŒŒë¼ë¯¸í„° ë“± ê¸°ìˆ ìš©ì–´ëŠ” ë°˜ë“œì‹œ êµ¬ì²´ì  ìœ„ì¹˜ì™€ ë°©ë²• ëª…ì‹œ
4. "ì„¤ì •í•˜ì„¸ìš”", "ì¶”ê°€í•˜ì„¸ìš”" ê°™ì€ ì¶”ìƒì  í‘œí˜„ ê¸ˆì§€

# ğŸš¨ **ì™•ì´ˆë³´ ê¸°ì¤€ ê°€ì´ë“œ ì‘ì„±ë²•**:

## í•„ìˆ˜ í¬í•¨ì‚¬í•­:
- **ì •í™•í•œ URL**: https://ë¡œ ì‹œì‘í•˜ëŠ” ì™„ì „í•œ ì£¼ì†Œ
- **ì •í™•í•œ ë²„íŠ¼ëª…**: "íŒŒë€ìƒ‰ 'ë¡œê·¸ì¸' ë²„íŠ¼", "ì˜¤ë¥¸ìª½ ìƒë‹¨ 'ê³„ì • ì„¤ì •' ë§í¬"
- **ì •í™•í•œ ì…ë ¥ê°’**: ì–´ë””ì— ë¬´ì—‡ì„ ì…ë ¥í•˜ëŠ”ì§€
- **ì •í™•í•œ ìœ„ì¹˜**: "í™”ë©´ ì™¼ìª½", "í˜ì´ì§€ í•˜ë‹¨", "íŒì—…ì°½ ì¤‘ì•™"
- **í™•ì¸ ë°©ë²•**: "ì„±ê³µì‹œ ì´ˆë¡ìƒ‰ ë©”ì‹œì§€ í‘œì‹œ", "ì„¤ì • ì™„ë£Œì‹œ ì²´í¬ë§ˆí¬ ë‚˜íƒ€ë‚¨"

## ìë™í™” ìˆ˜ì¤€ë³„ ìƒì„¸ ìˆ˜ì¤€:
- **ìˆ˜ë™**: ëª¨ë“  í´ë¦­ê³¼ ì…ë ¥ì„ ë‹¨ê³„ë³„ë¡œ
- **ë°˜ìë™**: ì„¤ì •ê°’ì˜ ì •í™•í•œ ìœ„ì¹˜ì™€ ê°’ê¹Œì§€  
- **ì™„ì „ìë™**: í…ŒìŠ¤íŠ¸ ë°©ë²•ê³¼ ì—ëŸ¬ í•´ê²°ê¹Œì§€

## ğŸš¨ **ì™•ì´ˆë³´ ê¸°ì¤€ ì„¤ëª… ì˜ˆì‹œ**:

### âŒ **ë‚˜ìœ ì˜ˆì‹œ (ì¶”ìƒì )**:
- "ë„¤ì´ë²„ ê´‘ê³  APIì— ì ‘ì†í•˜ì—¬ API í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤"
- "ì•±ì„ ìƒì„±í•˜ê³  ê´‘ê³  APIë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤"  
- "ì¸ì¦ í† í°ê³¼ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤"

### âœ… **ì¢‹ì€ ì˜ˆì‹œ (êµ¬ì²´ì )**:
- "1. í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì—´ê³  ì£¼ì†Œì°½ì— https://developers.naver.com/apps ì…ë ¥ í›„ Enter
   2. í™”ë©´ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ íŒŒë€ìƒ‰ 'ë¡œê·¸ì¸' ë²„íŠ¼ í´ë¦­
   3. ë„¤ì´ë²„ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ë¡œê·¸ì¸
   4. ë¡œê·¸ì¸ í›„ í™”ë©´ ì¤‘ì•™ì˜ ì´ˆë¡ìƒ‰ 'ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡' ë²„íŠ¼ í´ë¦­
   5. 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„' í•„ë“œì— 'ë‚´ê´‘ê³ ìë™í™”' ì…ë ¥
   6. í™”ë©´ì„ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ 'ê´‘ê³ API' ì²´í¬ë°•ìŠ¤ì— ì²´í¬
   7. í˜ì´ì§€ í•˜ë‹¨ì˜ íŒŒë€ìƒ‰ 'ë“±ë¡í•˜ê¸°' ë²„íŠ¼ í´ë¦­
   8. ë“±ë¡ ì™„ë£Œ í›„ ë‚˜íƒ€ë‚˜ëŠ” 'Client ID' ê°’ì„ ë©”ëª¨ì¥ì— ë³µì‚¬í•´ì„œ ì €ì¥"

## ğŸ”— **ì—°ê²°ëœ ì›Œí¬í”Œë¡œìš° ì„¤ê³„ í•„ìˆ˜ ì›ì¹™**:
1. **í•˜ë‚˜ì˜ ìë™í™” í”Œë«í¼**: ëª¨ë“  ë‹¨ê³„ê°€ í•˜ë‚˜ì˜ Zapier/Make.com ì›Œí¬í”Œë¡œìš°ì—ì„œ ì—°ê²°
2. **ëª…í™•í•œ ë°ì´í„° íë¦„**: ì´ì „ ë‹¨ê³„ ì¶œë ¥ â†’ í˜„ì¬ ë‹¨ê³„ ì…ë ¥ â†’ ë‹¤ìŒ ë‹¨ê³„ ì…ë ¥ì˜ êµ¬ì²´ì  ê²½ë¡œ
3. **ì‹¤ì œ ì—°ê²° êµ¬í˜„**: "ì›¹í›… URL", "í•„í„° ì¡°ê±´", "ë°ì´í„° ë§¤í•‘" ë“± êµ¬ì²´ì  ì—°ê²° ë°©ë²• ëª…ì‹œ
4. **ì „ì²´ ë§¥ë½ ì¸ì‹**: í˜„ì¬ ë‹¨ê³„ê°€ ì „ì²´ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì–´ë–¤ ì—­í• ì¸ì§€ ëª…ì‹œ
5. **ìµœì  íš¨ìœ¨ì„±**: ê°€ì¥ ë¹ ë¥´ê³  ì‰¬ìš´ ë°©ë²• (AI ë„êµ¬ê°€ ë” íš¨ìœ¨ì ì´ë©´ ë‹¹ì—°íˆ AI ë„êµ¬ ì„ íƒ)

## ğŸš¨ **ì´ ë‹¨ê³„ì˜ ì—­í• ê³¼ ì—°ê²°ì„±**:
- **ì…ë ¥**: ì´ì „ ë‹¨ê³„ì—ì„œ ë°›ëŠ” êµ¬ì²´ì  ë°ì´í„°/íŒŒì¼/ì‹ í˜¸
- **ì²˜ë¦¬**: ì´ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰í•˜ëŠ” ë³€í™˜/ë¶„ì„/ì‘ì—…
- **ì¶œë ¥**: ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬í•˜ëŠ” êµ¬ì²´ì  ë°ì´í„°/íŒŒì¼/ì‹ í˜¸
- **ì—°ê²°ë°©ë²•**: Zapier/Make.comì—ì„œ ì–´ë–»ê²Œ ë°ì´í„°ë¥¼ ë°›ê³  ì „ë‹¬í•˜ëŠ”ì§€

# MUST RETURN ONLY VALID JSON (NO OTHER TEXT):
{
  "cards": [
    {
      "type": "guide",
      "stepId": "${step.id}",
      "title": "${step.title}",
      "subtitle": "ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆëŠ” ì„¤ëª…",
      "basicConcept": "ì´ ë‹¨ê³„ì˜ ëª©ì ê³¼ í•„ìš”ì„±",
      "automationLevel": "ì´ ë‹¨ê³„ì˜ ìë™í™” ìˆ˜ì¤€",
      "content": {
        "fromPreviousStep": "ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±ëœ êµ¬ì²´ì  ê²°ê³¼ë¬¼ì„ í˜„ì¬ ë‹¨ê³„ ì…ë ¥ìœ¼ë¡œ í™œìš©í•˜ëŠ” ë°©ë²• (ì˜ˆ: '1ë‹¨ê³„ì—ì„œ ìƒì„±ëœ ì›¹í›… URLì„ 2ë‹¨ê³„ ì•Œë¦¼ ì„¤ì •ì˜ endpoint í•„ë“œì— ì…ë ¥')",
        "continuousWorkflow": "í•˜ë‚˜ì˜ Zapier/Make.com ì›Œí¬í”Œë¡œìš°ì—ì„œ ì´ ë‹¨ê³„ê°€ ì—°ê²°ë˜ëŠ” êµ¬ì²´ì  ë°©ë²• (ì˜ˆ: 'Filter ì¡°ê±´ìœ¼ë¡œ ì´ì „ ë°ì´í„° í•„í„°ë§ â†’ OpenAI ì•¡ì…˜ìœ¼ë¡œ ë¶„ì„ â†’ ë‹¤ìŒ ë‹¨ê³„ Slack ì•¡ì…˜ìœ¼ë¡œ ì „ë‹¬')",
        "workflowConnection": "ì „ì²´ ì›Œí¬í”Œë¡œìš°ì—ì„œì˜ ë°ì´í„° íë¦„: [ì´ì „ë‹¨ê³„ ì¶œë ¥] â†’ [í˜„ì¬ë‹¨ê³„ ì²˜ë¦¬] â†’ [ë‹¤ìŒë‹¨ê³„ ì…ë ¥]",
        "toolChoice": {
          "recommended": "ì¶”ì²œ ë„êµ¬ (ìµœì  íš¨ìœ¨ì„± ìš°ì„ , í†µí•© ì›Œí¬í”Œë¡œìš° ê³ ë ¤)",
          "reason": "ì™•ì´ˆë³´ë„ ë”°ë¼í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ + ìµœì  íš¨ìœ¨ì„± + ì´ì „ë‹¨ê³„ ì—°ê²°ì„±",
          "alternatives": [
            {
              "tool": "ëŒ€ì•ˆ ë„êµ¬",
              "pros": "ì¥ì ",
              "cons": "ë‹¨ì ",
              "whenToUse": "ì–¸ì œ ì‚¬ìš©í•˜ë©´ ì¢‹ì€ì§€"
            }
          ]
        },
        "detailedSteps": [
          {
            "number": 1,
            "title": "êµ¬ì²´ì ì¸ í–‰ë™ ì œëª©",
            "description": "ğŸš¨ ì™•ì´ˆë³´ë„ 100% ë”°ë¼í•  ìˆ˜ ìˆëŠ” ë§¤ìš° ìƒì„¸í•œ í´ë¦­ ê°€ì´ë“œ:\\n\\n1. [ì •í™•í•œ ë¸Œë¼ìš°ì € í–‰ë™]: í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì—´ê³  ì£¼ì†Œì°½ì— [ì •í™•í•œ URL] ì…ë ¥\\n2. [ì •í™•í•œ í´ë¦­ ìœ„ì¹˜]: í™”ë©´ì—ì„œ [ì •í™•í•œ ë²„íŠ¼ëª…/ë§í¬ëª…] í´ë¦­ (ì˜ˆ: ì˜¤ë¥¸ìª½ ìƒë‹¨ íŒŒë€ìƒ‰ 'ë¡œê·¸ì¸' ë²„íŠ¼)\\n3. [ì •í™•í•œ ì…ë ¥ê°’]: [êµ¬ì²´ì ì¸ í•„ë“œ]ì— [ì •í™•í•œ ê°’] ì…ë ¥\\n4. [ì •í™•í•œ ì„¤ì •ê°’]: [êµ¬ì²´ì ì¸ ì˜µì…˜]ì—ì„œ [ì •í™•í•œ ì„ íƒì§€] ì„ íƒ\\n5. [ì •í™•í•œ ì €ì¥ ë°©ë²•]: [êµ¬ì²´ì ì¸ ì €ì¥ ë²„íŠ¼] í´ë¦­í•˜ì—¬ ì™„ë£Œ\\n\\nâš ï¸ ì¤‘ìš”: API í‚¤, í† í°, íŒŒë¼ë¯¸í„° ë“± ê¸°ìˆ ìš©ì–´ëŠ” ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ê°’ê³¼ ìœ„ì¹˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.",
            "expectedScreen": "ì´ ë‹¨ê³„ë¥¼ ì™„ë£Œí–ˆì„ ë•Œ í™”ë©´ì— ì •í™•íˆ ë¬´ì—‡ì´ ë³´ì´ëŠ”ì§€",
            "checkpoint": "ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” êµ¬ì²´ì ì¸ ë°©ë²• (ì˜ˆ: 'í™”ë©´ì— ì´ˆë¡ìƒ‰ìœ¼ë¡œ ì„±ê³µ ë©”ì‹œì§€ê°€ í‘œì‹œë¨')"
          },
          {
            "number": 2,
            "title": "ë‘ ë²ˆì§¸ ì„¸ë¶€ ë‹¨ê³„",
            "description": "ğŸš¨ ì´ì „ ë‹¨ê³„ ê²°ê³¼ë¥¼ í™œìš©í•œ êµ¬ì²´ì  í–‰ë™:\\n\\n1. ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±ëœ [êµ¬ì²´ì  ê²°ê³¼ë¬¼]ì„ ë³µì‚¬\\n2. [ì •í™•í•œ ìœ„ì¹˜]ì—ì„œ [ì •í™•í•œ ë²„íŠ¼] í´ë¦­\\n3. [êµ¬ì²´ì ì¸ í•„ë“œëª…]ì— ë³µì‚¬í•œ ê°’ ë¶™ì—¬ë„£ê¸°\\n4. [ì¶”ê°€ ì„¤ì •]ì„ [ì •í™•í•œ ê°’]ìœ¼ë¡œ ë³€ê²½\\n5. [ìµœì¢… í™•ì¸ ë²„íŠ¼] í´ë¦­",
            "expectedScreen": "ë‘ ë²ˆì§¸ ë‹¨ê³„ ì™„ë£Œ í›„ ë³´ì´ëŠ” í™”ë©´",
            "checkpoint": "ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•"
          },
          {
            "number": 3,
            "title": "ìµœì¢… ì™„ë£Œ ë° í…ŒìŠ¤íŠ¸",
            "description": "ğŸš¨ ì„¤ì • ì™„ë£Œ ë° ì‘ë™ í™•ì¸:\\n\\n1. [ìµœì¢… ì„¤ì • í™”ë©´]ì—ì„œ ëª¨ë“  ê°’ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\\n2. [í…ŒìŠ¤íŠ¸ ë²„íŠ¼] í´ë¦­í•˜ì—¬ ì‹¤ì œ ì‘ë™ í…ŒìŠ¤íŠ¸\\n3. í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸ ë° ë¬¸ì œ í•´ê²°\\n4. [í™œì„±í™”/ì €ì¥ ë²„íŠ¼] í´ë¦­í•˜ì—¬ ìë™í™” ì‹œì‘\\n5. ì‹¤ì œ ê²°ê³¼ë¬¼ í™•ì¸ ë°©ë²•",
            "expectedScreen": "ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ê³  ìë™í™”ê°€ ì‘ë™í•˜ëŠ” í™”ë©´",
            "checkpoint": "ìë™í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•"
          }
        ],
        "automationBenefits": [
          "ì´ ë°©ë²•ì„ ì“°ë©´ ì–»ëŠ” êµ¬ì²´ì  ì´ìµ (ì‹œê°„/ë¹„ìš©/ì •í™•ë„ë¥¼ ìˆ«ìë¡œ)"
        ],
        "practicalTips": [
          "ğŸš¨ ì™•ì´ˆë³´ í•„ìˆ˜ íŒ: êµ¬ì²´ì ì¸ í–‰ë™ê³¼ í•¨ê»˜ (ì˜ˆ: 'API í‚¤ëŠ” ë©”ëª¨ì¥ì— ë°”ë¡œ ì €ì¥í•˜ì„¸ìš” - ë‚˜ì¤‘ì— ì°¾ê¸° ì–´ë ¤ì›€')"
        ],
        "commonMistakes": [
          {
            "mistake": "êµ¬ì²´ì ì¸ ì‹¤ìˆ˜ ìƒí™©",
            "why": "ì™œ ì´ ì‹¤ìˆ˜ê°€ ë°œìƒí•˜ëŠ”ì§€",
            "solution": "ì •í™•í•œ í•´ê²° ë°©ë²• (í´ë¦­/ì…ë ¥/ì„¤ì • ìœ„ì¹˜ í¬í•¨)",
            "prevention": "ë‹¤ìŒì— ì‹¤ìˆ˜í•˜ì§€ ì•ŠëŠ” ë°©ë²•"
          }
        ]
      }
    }
  ]
}`
            },
            {
              role: 'user',
              content: `# ğŸ”„ í”Œë¡œìš° ì—°ê²°ì„± ì •ë³´
ì „ì²´ í”Œë¡œìš°: ${JSON.stringify(steps.map((s: any) => ({ id: s.id, title: s.title })))}
í˜„ì¬ ë‹¨ê³„: ${step.id}ë²ˆì§¸ - ${step.title}
ì´ì „ ë‹¨ê³„ë“¤: ${previousSteps.map((s: any) => s.title).join(' â†’ ') || 'ì—†ìŒ'}

# ğŸ“‹ ì´ì „ ë‹¨ê³„ ê²°ê³¼ë¬¼ (ì—°ê²° í™œìš©)
${previousGuides.length > 0 ? 
  previousGuides.map(guide => 
`- ${guide.title}: ${guide.content?.detailedSteps?.[0]?.title || 'ì„¤ì • ì™„ë£Œ'}
  â†’ ê²°ê³¼ë¬¼: ${guide.content?.detailedSteps?.[0]?.expectedScreen || 'ì„¤ì •ëœ ì‹œìŠ¤í…œ'}`
).join('\n') : 'ì²« ë²ˆì§¸ ë‹¨ê³„ - ì´ì „ ê²°ê³¼ë¬¼ ì—†ìŒ'}

# ğŸ¯ í˜„ì¬ ë‹¨ê³„ ì •ë³´
ë‹¨ê³„ ì •ë³´: ${step.title} (${step.id}ë²ˆì§¸ ë‹¨ê³„)
ë‹¨ê³„ ì„¤ëª…: ${step.subtitle}
ì „ì²´ ëª©í‘œ: "${userInput}"
ì‚¬ìš©ì í›„ì†ë‹µë³€: ${JSON.stringify(followupAnswers || {})}

# ğŸš¨ ì›Œí¬í”Œë¡œìš° ì—°ê²°ì„± ì ˆëŒ€ ì›ì¹™ (í•„ìˆ˜):

## âŒ **ì ˆëŒ€ ê¸ˆì§€ë˜ëŠ” í‘œí˜„ë“¤**:
- "ìƒˆë¡œìš´ ì›Œí¬í”Œë¡œìš° ìƒì„±", "ìƒˆë¡œìš´ Zapier ë§Œë“¤ê¸°", "ë³„ë„ ìë™í™”"
- "ì²˜ìŒë¶€í„° ì‹œì‘", "ìƒˆ ì‹œë‚˜ë¦¬ì˜¤", "ë…ë¦½ì ìœ¼ë¡œ ì„¤ì •"
- "ê°œë³„ì ìœ¼ë¡œ", "ë”°ë¡œ ë§Œë“¤ê¸°", "ë¶„ë¦¬ëœ ìë™í™”"

## âœ… **ë°˜ë“œì‹œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” í‘œí˜„ë“¤**:
- "ì´ì „ ë‹¨ê³„ì—ì„œ ì´ì–´ì„œ", "ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì— ì¶”ê°€", "ì—°ê²°ëœ ë‹¤ìŒ ë‹¨ê³„"
- "ì´ì „ ë‹¨ê³„ ì¶œë ¥ì„ ì…ë ¥ìœ¼ë¡œ í™œìš©", "í•˜ë‚˜ì˜ í”Œë¡œìš°ì—ì„œ ê³„ì†"

## ğŸ”— **ë‹¨ê³„ë³„ ì—°ê²° ë°©ì‹**:
1. **1ë‹¨ê³„**: ì›Œí¬í”Œë¡œìš° ì‹œì‘ + ì²« ë²ˆì§¸ ì•¡ì…˜
2. **2ë‹¨ê³„**: 1ë‹¨ê³„ì™€ ê°™ì€ ì›Œí¬í”Œë¡œìš°ì—ì„œ + (Plus) ë²„íŠ¼ìœ¼ë¡œ ë‘ ë²ˆì§¸ ì•¡ì…˜ ì¶”ê°€
3. **3ë‹¨ê³„**: 2ë‹¨ê³„ì™€ ê°™ì€ ì›Œí¬í”Œë¡œìš°ì—ì„œ + (Plus) ë²„íŠ¼ìœ¼ë¡œ ì„¸ ë²ˆì§¸ ì•¡ì…˜ ì¶”ê°€

## ğŸ¯ **ì´ ë‹¨ê³„ì˜ ì—­í• ** (${step.id}ë²ˆì§¸ ë‹¨ê³„):
- **ì›Œí¬í”Œë¡œìš° ìœ„ì¹˜**: ${step.id === '1' ? 'ì›Œí¬í”Œë¡œìš° ì‹œì‘' : `ì´ì „ ${step.id-1}ë‹¨ê³„ì—ì„œ ì´ì–´ì„œ ${step.id}ë²ˆì§¸ ì•¡ì…˜ ì¶”ê°€`}
- **ë°ì´í„° ì…ë ¥**: ${step.id === '1' ? 'íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸' : 'ì´ì „ ë‹¨ê³„ ì¶œë ¥ ë°ì´í„°'}
- **ì—°ê²° ë°©ë²•**: ${step.id === '1' ? 'ì›Œí¬í”Œë¡œìš° ìƒì„±' : '+ (Plus) ë²„íŠ¼ìœ¼ë¡œ ì•¡ì…˜ ì¶”ê°€'}
- **ë°ì´í„° ì¶œë ¥**: ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬í•  êµ¬ì²´ì  ë°ì´í„°

# ğŸš¨ **ì™•ì´ˆë³´ ê°€ì´ë“œ í•„ìˆ˜ì‚¬í•­**:
- **ê·¹ë„ë¡œ ìƒì„¸í•œ ì„¤ëª…**: "ì–´ëŠ ë©”ë‰´ â†’ ëª‡ ë²ˆì§¸ ë²„íŠ¼ â†’ ì–´ë–¤ í•„ë“œì— ë¬´ì—‡ ì…ë ¥" ìˆ˜ì¤€ì˜ ì™„ë²½í•œ ì„¤ëª…
- **ê°œë°œì ë„êµ¬ ì´ˆë³´ì ê°€ì´ë“œ**: F12 ëˆ„ë¥´ëŠ” ê²ƒë¶€í„° ì‹œì‘í•´ì„œ ì •í™•í•œ íƒ­ê³¼ í´ë¦­ ìœ„ì¹˜ê¹Œì§€ ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ ì„¤ëª…
- **API URL ì°¾ê¸° ì™„ì „ ê°€ì´ë“œ**: Network íƒ­ì—ì„œ ì–´ë–¤ í•­ëª©ì„ í´ë¦­í•´ì•¼ í•˜ëŠ”ì§€ ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…
- **ì •í™•í•œ ë²„íŠ¼ëª…ê³¼ ìœ„ì¹˜**: "í™”ë©´ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ íŒŒë€ìƒ‰ 'ë¡œê·¸ì¸' ë²„íŠ¼" ìˆ˜ì¤€ì˜ ì •í™•í•œ ìœ„ì¹˜
- **ì„±ê³µ í™•ì¸ ë°©ë²•**: ì–´ë–¤ ë©”ì‹œì§€ê°€ ì–´ë””ì— ë‚˜íƒ€ë‚˜ì•¼ ì„±ê³µì¸ì§€ê¹Œì§€ ëª…ì‹œ

## ğŸ” **ê°œë°œì ë„êµ¬ ì™•ì´ˆë³´ ê°€ì´ë“œ ì˜ˆì‹œ**:
1. í‚¤ë³´ë“œì—ì„œ F12 í‚¤ë¥¼ ëˆ„ë¥´ë©´ í™”ë©´ ì•„ë˜ìª½ì´ë‚˜ ì˜¤ë¥¸ìª½ì— ê°œë°œì ë„êµ¬ ì°½ì´ ë‚˜íƒ€ë‚¨
2. ìƒë‹¨ íƒ­ ì¤‘ì—ì„œ 'Network' (ë˜ëŠ” 'ë„¤íŠ¸ì›Œí¬') íƒ­ì„ í´ë¦­
3. Network íƒ­ í™”ë©´ì—ì„œ 'XHR' ë²„íŠ¼ì„ í´ë¦­ (Ajax ìš”ì²­ë§Œ í•„í„°ë§)
4. ì›¹í˜ì´ì§€ì—ì„œ ìƒˆë¡œê³ ì¹¨(F5)ì„ ëˆŒëŸ¬ì„œ ë°ì´í„° ë¡œë”©
5. Network íƒ­ì— ë‚˜íƒ€ë‚˜ëŠ” ëª©ë¡ ì¤‘ 'api', 'ajax', 'data' í‚¤ì›Œë“œê°€ í¬í•¨ëœ í•­ëª© í´ë¦­
6. ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ 'Request URL' í•­ëª©ì„ ì°¾ì•„ì„œ ë§ˆìš°ìŠ¤ ìš°í´ë¦­ â†’ 'ë³µì‚¬' ì„ íƒ

## ğŸ“‹ **ìƒì„¸ ì„¤ëª… ê¸°ì¤€**:
- ëª¨ë“  ê¸°ìˆ ì  ë‹¨ê³„ëŠ” "ì–´ë–¤ í‚¤ë¥¼ ëˆ„ë¥´ê³  â†’ ì–´ëŠ ìœ„ì¹˜ì˜ ë¬´ìŠ¨ ë²„íŠ¼ì„ í´ë¦­í•˜ê³  â†’ ì–´ë–¤ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚˜ëŠ”ì§€" ì™„ë²½ ì„¤ëª…
- ìŠ¤í¬ë¦°ìƒ·ì´ ì—†ì–´ë„ ê¸€ë§Œ ë³´ê³  100% ë”°ë¼í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€

ì´ ë‹¨ê³„ì— ëŒ€í•œ ë„êµ¬ ì¶”ì²œ + ì™•ì´ˆë³´ë„ 100% ë”°ë¼í•  ìˆ˜ ìˆëŠ” ì´ˆê·¹ìƒì„¸ ì‹¤í–‰ ê°€ì´ë“œë¥¼ ìƒì„±í•˜ì„¸ìš”.`
            }
          ],
          max_tokens: 2000,
          temperature: 0.7
        });

        const guideContent = guideResponse.choices[0]?.message?.content;
        try {
          if (guideContent) {
            // ğŸ”§ ë” ì•ˆì „í•œ JSON íŒŒì‹± ë¡œì§
            let jsonContent = '';
            
            // ```jsonìœ¼ë¡œ ê°ì‹¸ì§„ ê²½ìš° ì¶”ì¶œ
            const jsonMatch = guideContent.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
              jsonContent = jsonMatch[1].trim();
            } else {
              // JSON ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì „ì²´ ë‚´ìš©ì—ì„œ JSON ì°¾ê¸°
              const startIndex = guideContent.indexOf('{');
              const lastIndex = guideContent.lastIndexOf('}');
              if (startIndex !== -1 && lastIndex !== -1 && lastIndex > startIndex) {
                jsonContent = guideContent.substring(startIndex, lastIndex + 1);
              } else {
                throw new Error('JSON êµ¬ì¡°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              }
            }
            
            // ğŸš€ JSON íŒŒì‹± (ê°•í™”ëœ ì—ëŸ¬ ì²˜ë¦¬)
            let parsed;
            try {
              parsed = JSON.parse(jsonContent);
            } catch (firstError) {
              console.log(`[2ë‹¨ê³„] ì²« ë²ˆì§¸ JSON íŒŒì‹± ì‹¤íŒ¨, ê°•í™”ëœ ì •ë¦¬ í›„ ì¬ì‹œë„...`);
              try {
                const cleanedJson = jsonContent
                  .replace(/[\u201C\u201D]/g, '"')  // ìŠ¤ë§ˆíŠ¸ ë”°ì˜´í‘œ â†’ ì¼ë°˜ ë”°ì˜´í‘œ
                  .replace(/[\u2018\u2019]/g, "'")  // ìŠ¤ë§ˆíŠ¸ ì•„í¬ìŠ¤íŠ¸ë¡œí”¼ â†’ ì¼ë°˜ ì•„í¬ìŠ¤íŠ¸ë¡œí”¼
                  .replace(/\n\s*\n/g, '\n')       // ì—°ì† ì¤„ë°”ê¿ˆ ì •ë¦¬
                  .replace(/\\n/g, '\\\\n')        // ì´ìŠ¤ì¼€ì´í”„ëœ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                  .replace(/"/g, '\\"')            // ë‚´ë¶€ ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„
                  .replace(/\\\\"/g, '"')          // ì‹œì‘/ë ë”°ì˜´í‘œëŠ” ë³µì›
                  .trim();
                
                // ë” ì•ˆì „í•œ JSON ì¬êµ¬ì„±
                const safeJson = cleanedJson
                  .replace(/,(\s*[}\]])/g, '$1')   // trailing comma ì œê±°
                  .replace(/([^\\])\\([^"\\\/bfnrtu])/g, '$1\\\\$2'); // ì˜ëª»ëœ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                
                parsed = JSON.parse(safeJson);
              } catch (secondError) {
                console.log(`[2ë‹¨ê³„] ë‘ ë²ˆì§¸ JSON íŒŒì‹±ë„ ì‹¤íŒ¨, í´ë°± ê°€ì´ë“œ ìƒì„±...`);
                console.log(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ê¸¸ì´: ${guideContent.length}`);
                console.log(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ì‹œì‘: ${guideContent.substring(0, 200)}`);
                console.log(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ë: ${guideContent.substring(Math.max(0, guideContent.length - 200))}`);
                
                // ì™„ì „ í´ë°±: ê¸°ë³¸ ê°€ì´ë“œ ìƒì„±
                parsed = {
                  cards: [{
                    type: 'guide',
                    stepId: step.id,
                    title: step.title,
                    subtitle: 'ìƒì„¸ ê°€ì´ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
                    basicConcept: `${step.title} ë‹¨ê³„ë¥¼ ìœ„í•œ ê¸°ë³¸ ê°€ì´ë“œì…ë‹ˆë‹¤.`,
                    automationLevel: 'ìˆ˜ë™',
                    content: {
                      detailedSteps: [{
                        number: 1,
                        title: `${step.title} ì„¤ì •`,
                        description: `${step.title}ì„(ë¥¼) ì„¤ì •í•©ë‹ˆë‹¤. ìƒì„¸ ê°€ì´ë“œëŠ” ê³§ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤.`,
                        expectedScreen: `${step.title} ì„¤ì • ì™„ë£Œ í™”ë©´`,
                        checkpoint: `${step.title}ì´(ê°€) ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸`
                      }],
                      practicalTips: ['ìƒì„¸ ê°€ì´ë“œëŠ” ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤'],
                      commonMistakes: []
                    }
                  }]
                };
              }
            }
            
            const stepGuides = parsed.cards || [];
            if (stepGuides.length > 0) {
              guideCards.push(...stepGuides);
              console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ê°€ì´ë“œ ìƒì„± âœ… (${stepGuides.length}ê°œ ì¹´ë“œ)`);
              console.log(`[2ë‹¨ê³„] ìƒì„±ëœ ê°€ì´ë“œ: ${stepGuides[0].title}`);
            } else {
              console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„: cards ë°°ì—´ì´ ë¹„ì–´ìˆìŒ`);
            }
          }
        } catch (error) {
          console.error(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ íŒŒì‹± ì˜¤ë¥˜:`, error);
          console.error(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ê¸¸ì´:`, guideContent?.length);
          console.error(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ì‹œì‘:`, guideContent?.substring(0, 200));
          console.error(`[2ë‹¨ê³„] ì›ë³¸ ì‘ë‹µ ë:`, guideContent?.substring(-200));
          
          // ğŸ”„ íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ê°€ì´ë“œ ì¹´ë“œ ìƒì„± (ìµœí›„ì˜ ìˆ˜ë‹¨)
          const fallbackGuide = {
            type: 'guide',
            stepId: step.id,
            title: step.title,
            subtitle: 'ìƒì„¸ ê°€ì´ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
            basicConcept: `${step.title} ë‹¨ê³„ë¥¼ ìœ„í•œ ê¸°ë³¸ ê°€ì´ë“œì…ë‹ˆë‹¤.`,
            automationLevel: 'ìˆ˜ë™',
            content: {
              detailedSteps: [
                {
                  number: 1,
                  title: `${step.title} ì¤€ë¹„í•˜ê¸°`,
                  description: 'ì´ ë‹¨ê³„ì— ëŒ€í•œ ìƒì„¸ ê°€ì´ë“œëŠ” í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ê³§ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.',
                  expectedScreen: 'ì„¤ì • í™”ë©´',
                  checkpoint: 'ê¸°ë³¸ ì„¤ì • ì™„ë£Œ'
                }
              ],
              practicalTips: ['ìƒì„¸ ê°€ì´ë“œëŠ” ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤'],
              commonMistakes: []
            }
          };
          guideCards.push(fallbackGuide);
          console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„: í´ë°± ê°€ì´ë“œ ìƒì„±ë¨`);
        }
      } catch (error) {
        console.error(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ìƒì„± ì˜¤ë¥˜:`, error);
      }
    }

    allCards.push(...guideCards);
    console.log(`[2ë‹¨ê³„] ìµœì¢… ìƒì„±ëœ ê°€ì´ë“œ ì¹´ë“œ ìˆ˜: ${guideCards.length}/${steps.length}`);
    console.log(`[2ë‹¨ê³„] ìƒì„±ëœ ê°€ì´ë“œ ì¹´ë“œë“¤:`, guideCards.map((card: any) => ({
      stepId: card.stepId,
      title: card.title,
      hasDetailedSteps: !!(card.content?.detailedSteps?.length > 0)
    })));

    // ğŸ”„ 3ë‹¨ê³„: FAQ + í™•ì¥ ì•„ì´ë””ì–´ (gpt-4o-mini - ë¹„ìš©ì ˆì•½)
    console.log('[3ë‹¨ê³„] FAQ + í™•ì¥ ì•„ì´ë””ì–´ (gpt-4o-mini - ë¹„ìš©ì ˆì•½)');
    const stage3Response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `ë‹¹ì‹ ì€ ì‹¤ì „ ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. FAQì™€ í™•ì¥ ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•˜ì„¸ìš”.

# ë°˜ë“œì‹œ JSON í˜•íƒœë¡œ ì‘ë‹µ:
{
  "cards": [
    {
      "type": "faq",
      "title": "â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸",
      "items": [
        {
          "question": "ì‹¤ì œ ìƒí™©ë³„ ì§ˆë¬¸",
          "answer": "êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‹µë³€"
        }
      ]
    },
    {
      "type": "expansion", 
      "title": "ğŸš€ í™•ì¥ ì•„ì´ë””ì–´",
      "subtitle": "ë” í° ê°€ì¹˜ ì°½ì¶œ",
      "possibilities": [
        "í˜„ì¬ ìë™í™”ë¥¼ ë” í° ì‹œìŠ¤í…œìœ¼ë¡œ í™•ì¥í•˜ëŠ” ë°©ë²•ë“¤ (AI ë„êµ¬ í™œìš© ì¤‘ì‹¬)"
      ],
      "futureVision": [
        "GPT-4o/Claude 3.5 Sonnet ë“± ìµœì‹  AIë¡œ ë” ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë°œì „ì‹œí‚¤ëŠ” ë°©í–¥"
      ]
    },
    {
      "type": "method_recommendation",
      "title": "ğŸ› ï¸ ì¶”ì²œ ë°©ë²•",
      "subtitle": "ìƒí™©ë³„ ìµœì  ë°©ë²•",
      "methods": [
        {
          "name": "ë°©ë²•ëª…",
          "description": "ì„¤ëª…",
          "pros": ["ì¥ì ë“¤"],
          "cons": ["ë‹¨ì ë“¤"],
          "difficulty": "ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€"
        }
      ]
    },
    {
      "type": "share",
      "title": "ğŸ“¤ ê³µìœ í•˜ê¸°",
      "subtitle": "ê²°ê³¼ ê³µìœ  ë° í˜‘ì—…",
      "shareOptions": [
        "ê³µìœ  ë°©ë²•ë“¤"
      ]
    }
  ]
}`
        },
        {
          role: 'user',
          content: `ì „ì²´ ëª©í‘œ: ${userInput}
ìƒì„±ëœ í”Œë¡œìš°: ${JSON.stringify(flowCard?.steps || [])}
í›„ì† ë‹µë³€: ${JSON.stringify(followupAnswers || {})}

# ğŸ› ï¸ ë‹¤ì–‘í•œ ì†”ë£¨ì…˜ ì ‘ê·¼ë²• ì¤‘ì‹¬ ì§€ì¹¨:

## FAQ ì‘ì„± ì‹œ:
- "ê¸°ìˆ ì  ì§€ì‹ì´ ì—†ì–´ë„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€?"
- "ì˜ˆì‚°ì´ ì œí•œì ì¼ ë•Œ ë¬´ë£Œë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì€?"
- "ê¸°ì¡´ ë„êµ¬(ë…¸ì…˜, ì—‘ì…€ ë“±)ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ëŠ” ë°©ë²•ì€?"
- "íšŒì‚¬ ë³´ì•ˆ ì •ì±… ë•Œë¬¸ì— ì™¸ë¶€ ë„êµ¬ë¥¼ ëª» ì“¸ ë•ŒëŠ”?"

## í™•ì¥ ì•„ì´ë””ì–´ ì‘ì„± ì‹œ:
- **í˜„ì¬ ë°©ë²• â†’ ë” ìŠ¤ë§ˆíŠ¸í•œ ë°©ë²•ë“¤**ë¡œ ë‹¨ê³„ë³„ ë°œì „
- **ê°œì¸ ì‚¬ìš© â†’ íŒ€ í˜‘ì—… â†’ ì¡°ì§ ì „ì²´ ì‹œìŠ¤í…œ**
- **ìˆ˜ë™ ì²˜ë¦¬ â†’ ë°˜ìë™ â†’ ì™„ì „ ìë™**
- **ì¼íšŒì„± â†’ ì§€ì†ì  ëª¨ë‹ˆí„°ë§ â†’ ì˜ˆì¸¡ ê¸°ëŠ¥**

## ì¶”ì²œ ë°©ë²• ì‘ì„± ì‹œ (ìµœì  ë°©ë²• 1ê°œ + ê°„ë‹¨í•œ ëŒ€ì•ˆ 1-2ê°œ):
- **ğŸ† ìµœì  ë°©ë²•**: í›„ì†ë‹µë³€ ê¸°ë°˜ìœ¼ë¡œ ì´ ì‚¬ìš©ìì—ê²Œ ê°€ì¥ ì í•©í•œ ë°©ë²•
- **ğŸ”„ ê°„ë‹¨í•œ ëŒ€ì•ˆ**: 1-2ê°œì˜ ëŒ€ì•ˆë§Œ ê°„ëµíˆ ì œì‹œ
- **âŒ ì•ˆ ì¶”ì²œí•˜ëŠ” ë°©ë²•**: ì™œ ë‹¤ë¥¸ ë°©ë²•ë“¤ì€ ì´ ì‚¬ìš©ìì—ê²Œ ì í•©í•˜ì§€ ì•Šì€ì§€

ì‹¤ì „ FAQ, í™•ì¥ ì•„ì´ë””ì–´, ì¶”ì²œ ë°©ë²•, ê³µìœ  ì˜µì…˜ì„ ìƒì„±í•˜ì„¸ìš”.`
        }
      ],
      max_tokens: 1500,
      temperature: 0.7
    });

    // 3ë‹¨ê³„ ê²°ê³¼ íŒŒì‹±
    const stage3Content = stage3Response.choices[0]?.message?.content;
    try {
      if (stage3Content) {
        const jsonMatch = stage3Content.match(/```json\s*([\s\S]*?)\s*```/);
        const jsonContent = jsonMatch ? jsonMatch[1] : stage3Content;
        const parsed = JSON.parse(jsonContent);
        const stage3Cards = parsed.cards || [];
        allCards.push(...stage3Cards);
        console.log(`[3ë‹¨ê³„] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${stage3Cards.length}`);
      }
    } catch (error) {
      console.error('[3ë‹¨ê³„] íŒŒì‹± ì˜¤ë¥˜:', error);
    }

    const processingTime = Date.now() - startTime;
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${allCards.length}`);
    console.log(`[ğŸ’° ë¹„ìš© ìµœì í™”] 1ë‹¨ê³„: gpt-4o-2024-11-20 ($2.50/$10.00), 2ë‹¨ê³„: gpt-4o-2024-11-20 ($2.50/$10.00), 3ë‹¨ê³„: gpt-4o-mini ($0.15/$0.60)`);
    console.log(`[âš¡ ì†ë„ ìµœì í™”] 1,2ë‹¨ê³„: 1ì´ˆë”œë ˆì´ (4o RPMí•œë„ íšŒí”¼), 3ë‹¨ê³„: ë¹ ë¥¸ì‘ë‹µ (mini ë†’ì€RPM)`);
    console.log(`[ğŸ¨ í’ˆì§ˆ ìµœì í™”] í”Œë¡œìš°+ê°€ì´ë“œëŠ” ìµœê³ í’ˆì§ˆ ëª¨ë¸, FAQë§Œ íš¨ìœ¨ì  ì²˜ë¦¬`);
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] [ìµœì¢… cards ìˆ˜]: ${allCards.length}`);
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] [ì¹´ë“œ íƒ€ì…ë“¤]:`, allCards.map((card: any) => card.type));

    // ğŸ¯ ë©”íƒ€ë°ì´í„° ì¶”ê°€
    const response_data = {
      cards: allCards,
      metadata: {
        generatedAt: new Date().toISOString(),
        processingTime: processingTime,
        approach: '3ë‹¨ê³„_í•˜ì´ë¸Œë¦¬ë“œ_ìµœì í™”',
        stages: {
          stage1: 'gpt-4o-2024-11-20 (ë‹ˆì¦ˆ+í”Œë¡œìš°)',
          stage2: 'gpt-4o-2024-11-20 (ìƒì„¸ê°€ì´ë“œ)',
          stage3: 'gpt-4o-mini (FAQ+í™•ì¥)'
        },
        costOptimization: '33%ì ˆì•½ (FAQë§Œ mini ì‚¬ìš©)',
        speedOptimization: '1ì´ˆëŒ€ê¸° (4o RPMí•œë„ íšŒí”¼)',
        qualityMaintained: 'í”Œë¡œìš°+ê°€ì´ë“œëŠ” ìµœê³ í’ˆì§ˆ ìœ ì§€'
      }
    };

    // ğŸ’¾ Supabaseì— ìë™í™” ìš”ì²­ ë°ì´í„° ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
    try {
      await saveAutomationRequest({
        user_input: userInput,
        followup_answers: followupAnswers,
        generated_cards: allCards,
        user_session_id: `session_${Date.now()}`, // ì„ì‹œ ì„¸ì…˜ ID
        processing_time_ms: processingTime,
        success: true
      });
      console.log('âœ… ìë™í™” ìš”ì²­ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
    } catch (saveError) {
      console.error('âš ï¸ ìë™í™” ìš”ì²­ ì €ì¥ ì‹¤íŒ¨ (ì‘ë‹µì€ ì •ìƒ ì§„í–‰):', saveError);
      // ì €ì¥ ì‹¤íŒ¨í•´ë„ ì‘ë‹µì€ ì •ìƒ ë°˜í™˜
    }

    return NextResponse.json(response_data);

  } catch (error) {
    console.error('âŒ ìë™í™” ìƒì„± ì‹¤íŒ¨:', error);
    
    // ğŸ’¾ ì‹¤íŒ¨í•œ ìš”ì²­ë„ Supabaseì— ì €ì¥ (ë¶„ì„ìš©)
    try {
      await saveAutomationRequest({
        user_input: userInput || 'Unknown input',
        followup_answers: followupAnswers || {},
        generated_cards: [],
        user_session_id: `session_${Date.now()}`,
        processing_time_ms: Date.now() - startTime,
        success: false,
        error_message: error instanceof Error ? error.message : 'Unknown error'
      });
      console.log('âœ… ì‹¤íŒ¨í•œ ìš”ì²­ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
    } catch (saveError) {
      console.error('âš ï¸ ì‹¤íŒ¨ ìš”ì²­ ì €ì¥ ì‹¤íŒ¨:', saveError);
    }
    
    return handleApiError(error);
  }
} 