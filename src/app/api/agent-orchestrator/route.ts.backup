import { NextRequest, NextResponse } from 'next/server';
import { callOpenAI } from '@/lib/openai';
import { AutomationData } from '@/app/types/automation';
import { handleError, handleApiError } from '@/lib/error-handler';
import { selectOptimalTool, WowTool } from '@/lib/wow-tool-registry';
import OpenAI from 'openai';
import { z } from 'zod';

// ğŸ¯ ë¡œê·¸ í­ì£¼ ë°©ì§€ (ê°œë°œí™˜ê²½ì—ì„œë§Œ ì¶œë ¥)
const originalLog = console.log;
console.log = (...args) => process.env.NODE_ENV === 'development' && originalLog(...args);

// ğŸ”§ Zod ìŠ¤í‚¤ë§ˆ ì •ì˜ - Function Callingìš©
const DetailedStepSchema = z.object({
  number: z.number(),
  title: z.string(),
  description: z.string(),
  expectedScreen: z.string(),
  checkpoint: z.string()
});

const ImportBlockSchema = z.object({
  make_import_json: z.string().optional(),
  sheet_header_csv: z.string().optional(),
  zapier_template: z.string().optional()
});

const CommonErrorSchema = z.object({
  code: z.string(),
  cause: z.string(),
  fix: z.string()
});

const GuideContentSchema = z.object({
  fromPreviousStep: z.string(),
  toolChoice: z.object({
    recommended: z.string(),
    reason: z.string(),
    alternatives: z.array(z.string()).optional()
  }),
  detailedSteps: z.array(DetailedStepSchema),
  importBlocks: ImportBlockSchema.default({}),
  commonErrors: z.array(CommonErrorSchema).default([
    {code: 'UNKNOWN', cause: '-', fix: '-'}, 
    {code: '-', cause: '-', fix: '-'}
  ]), // ê¸°ë³¸ê°’ ì¶”ê°€ - Stage-2 Skip ê²½ë¡œì—ì„œ ìë™ ì£¼ì…
  successCheck: z.string(),
  practicalTips: z.array(z.string()).optional()
});

const GuideCardSchema = z.object({
  type: z.literal('guide'),
  stepId: z.string(),
  title: z.string(),
  subtitle: z.string(),
  basicConcept: z.string(),
  automationLevel: z.enum(['ìˆ˜ë™', 'ë°˜ìë™', 'ì™„ì „ìë™']),
  content: GuideContentSchema,
  ecosystem: z.enum(['make', 'zapier', 'google', 'notion', 'manual']).optional()
});

// ğŸ¯ ìƒˆë¡œìš´ WOW ì¹´ë“œ íƒ€ì… ìŠ¤í‚¤ë§ˆë“¤
const WowGuideCardSchema = z.object({
  type: z.enum(['slide_guide', 'video_guide', 'landing_guide', 'dashboard_guide', 'creative_guide', 'audio_guide', 'chatbot_guide']),
  title: z.string(),
  subtitle: z.string(),
  detailedSteps: z.array(DetailedStepSchema), // min(1) ì œê±° - 0-stepë„ ê°€ëŠ¥
  importBlocks: ImportBlockSchema.default({}),
  outputFormat: z.string(),
  pricing: z.string(),
  commonErrors: z.array(CommonErrorSchema).default([
    {code: 'UNKNOWN', cause: '-', fix: '-'}, 
    {code: '-', cause: '-', fix: '-'}
  ]), // ê¸°ë³¸ê°’ ì¶”ê°€
  setupTime: z.string()
});

const ToolRecommendationCardSchema = z.object({
  type: z.literal('tool_recommendation'),
  recommendedTool: z.string(),
  wowScore: z.number(),
  reason: z.string(),
  alternatives: z.array(z.string()),
  pricing: z.string()
});

const WowPreviewCardSchema = z.object({
  type: z.literal('wow_preview'),
  beforeState: z.string(),
  afterState: z.string(),
  timeToValue: z.string(),
  keyBenefits: z.array(z.string())
});

const GuideResponseSchema = z.object({
  cards: z.array(GuideCardSchema)
});

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ğŸ¯ Stage-1 Function Calling ìŠ¤í‚¤ë§ˆ
const Stage1ResponseSchema = z.object({
  cards: z.array(z.any()) // Stage-1ì—ì„œëŠ” ë‹¤ì–‘í•œ ì¹´ë“œ íƒ€ì…ì´ ë‚˜ì˜¬ ìˆ˜ ìˆì–´ì„œ any ì‚¬ìš©
});

// ğŸ” Tavily ê²€ìƒ‰ìœ¼ë¡œ API ì¡´ì¬ ì—¬ë¶€ í™•ì¸
async function checkApiStatusWithTavily(targetPlatform: string): Promise<{platform: string, hasApi: boolean, reason: string}> {
  try {
    const searchQuery = `${targetPlatform} official API documentation 2024`;
    
    const response = await fetch('/api/search-latest', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: searchQuery,
        maxResults: 3
      })
    });
    
    if (!response.ok) {
      console.warn(`[Tavily] ê²€ìƒ‰ ì‹¤íŒ¨: ${response.status}`);
      return {platform: targetPlatform, hasApi: false, reason: "ê²€ìƒ‰ ë¶ˆê°€ëŠ¥"};
    }
    
    const searchResults = await response.json();
    
    // ğŸ¯ ë¹ˆ ê²€ìƒ‰ê²°ê³¼ graceful fallback
    if (!searchResults.results?.length) {
      return {platform: targetPlatform, hasApi: false, reason: "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"};
    }
    
    const hasApiKeywords = ['api', 'developer', 'documentation', 'endpoint', 'rest'];
    const noApiKeywords = ['unofficial', 'scraping', 'no api', 'ë¹„ê³µì‹'];
    
    const allText = searchResults.results?.map((r: any) => r.content || '').join(' ').toLowerCase() || '';
    
    const hasApiScore = hasApiKeywords.filter(keyword => allText.includes(keyword)).length;
    const noApiScore = noApiKeywords.filter(keyword => allText.includes(keyword)).length;
    
    const hasApi = hasApiScore > noApiScore;
    const reason = hasApi ? `ê³µì‹ API ë¬¸ì„œ ë°œê²¬ (ì‹ ë¢°ë„: ${hasApiScore})` : `ê³µì‹ API ì—†ìŒ (ëŒ€ì•ˆ í•„ìš”: ${noApiScore})`;
    
    console.log(`[Tavily] ${targetPlatform} API ìƒíƒœ: ${hasApi ? 'ìˆìŒ' : 'ì—†ìŒ'} - ${reason}`);
    return {platform: targetPlatform, hasApi, reason};
    
  } catch (error) {
    console.error(`[Tavily] ${targetPlatform} ê²€ìƒ‰ ì˜¤ë¥˜:`, error);
    return {platform: targetPlatform, hasApi: false, reason: "ê²€ìƒ‰ ì˜¤ë¥˜"};
  }
}

// ğŸ¯ í˜„ì‹¤ì  ì ˆì¶©ì•ˆ: 3ë‹¨ê³„ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€ + ë¶€ë¶„ ìµœì í™”)
export async function POST(req: Request) {
  try {
    const { userInput, followupAnswers } = await req.json();
    
    console.log('ğŸš€ [í•˜ì´ë¸Œë¦¬ë“œ] 3ë‹¨ê³„ ìë™í™” ìƒì„± ì‹œì‘');
    console.log('ğŸ“ ì‚¬ìš©ì ì…ë ¥:', userInput);
    console.log('ğŸ“‹ í›„ì† ë‹µë³€:', followupAnswers);

    const startTime = Date.now();
    let allCards = [];

    // ğŸ¯ WOW íˆ´ ì„ íƒ (í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë§¤ì¹­)
    const selectedWowTool = selectOptimalTool(userInput, followupAnswers);
    console.log(`ğŸš€ [WOW íˆ´ ì„ íƒ] ${selectedWowTool.name} (${selectedWowTool.type}) - ìŠ¤ì½”ì–´: ${selectedWowTool.wowScore}`);
    
    // ğŸ” Tavilyë¡œ API ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸ (ì›Œí¬í”Œë¡œìš° íƒ€ì…ë§Œ)
    let apiStatus = null;
    if (selectedWowTool.type === 'workflow') {
      // ì‚¬ìš©ì ì…ë ¥ì—ì„œ íƒ€ê²Ÿ í”Œë«í¼ ì¶”ì¶œ (ì¿ íŒ¡, ì¡ì½”ë¦¬ì•„ ë“±)
      const platformKeywords = ['ì¿ íŒ¡', 'ì¡ì½”ë¦¬ì•„', 'ë‹¹ê·¼ë§ˆì¼“', 'ë°°ë¯¼', 'ìš”ê¸°ìš”', 'ì¹´ì¹´ì˜¤í†¡', 'ì¸ìŠ¤íƒ€ê·¸ë¨'];
      const targetPlatform = platformKeywords.find(platform => userInput.includes(platform));
      
      if (targetPlatform) {
        console.log(`[Tavily] ${targetPlatform} API ìƒíƒœ í™•ì¸ ì¤‘...`);
        apiStatus = await checkApiStatusWithTavily(targetPlatform);
      }
    }

    // ğŸ”„ 1ë‹¨ê³„: ë‹ˆì¦ˆ ë¶„ì„ + í”Œë¡œìš° ìƒì„± (gpt-4o-2024-11-20 - í’ˆì§ˆ ìš°ì„ )
    console.log('[1ë‹¨ê³„] ë‹ˆì¦ˆ ë¶„ì„ + í”Œë¡œìš° ìƒì„± (gpt-4o-2024-11-20 - í’ˆì§ˆ ìš°ì„ )');
    const stage1Response = await openai.chat.completions.create({
      model: 'gpt-4o-2024-11-20',
      tools: [{
        type: 'function',
        function: {
          name: 'return_cards',
          description: 'ìƒì„±ëœ ì¹´ë“œë“¤ì„ ë°˜í™˜í•©ë‹ˆë‹¤',
          parameters: {
            type: 'object',
            properties: {
              cards: {
                type: 'array',
                items: {
                  type: 'object'
                }
              }
            },
            required: ['cards']
          }
        }
      }],
      tool_choice: 'required',
      messages: [
        {
          role: 'system',
          content: `ë‹¹ì‹ ì€ 2025ë…„ WOW ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ì§„ì§œ WOWí•œ ê²½í—˜ì„ ì œê³µí•˜ëŠ” ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ì¶”ì²œí•˜ì„¸ìš”.

CRITICAL FUNCTION CALLING RULE: ë°˜ë“œì‹œ return_cards í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì¹´ë“œ ë°°ì—´ì„ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. ë¹ˆ ê°ì²´ë‚˜ ì¼ë°˜ í…ìŠ¤íŠ¸ ì‘ë‹µì€ ì ˆëŒ€ ê¸ˆì§€ì…ë‹ˆë‹¤.

## ì¶”ì²œëœ WOW íˆ´ ì •ë³´
- **ì„ íƒëœ íˆ´**: ${selectedWowTool.name}
- **íˆ´ íƒ€ì…**: ${selectedWowTool.type}  
- **WOW ì ìˆ˜**: ${selectedWowTool.wowScore}/10
- **ì‚¬ìš©ë²•**: ${selectedWowTool.how}
- **URL**: ${selectedWowTool.url}
- **ê°€ê²©**: ${selectedWowTool.pricing}
- **í•œêµ­ì–´ ì§€ì›**: ${selectedWowTool.koreanSupport ? 'ì§€ì›' : 'ë¯¸ì§€ì›'}
- **ë‚œì´ë„**: ${selectedWowTool.difficulty}
- **ì„¤ì • ì‹œê°„**: ${selectedWowTool.setupTime}

${apiStatus ? `
## ğŸ” ì‹¤ì‹œê°„ API ìƒíƒœ (Tavily ê²€ìƒ‰ ê²°ê³¼)
- **í”Œë«í¼**: ${apiStatus.platform}
- **API ìƒíƒœ**: ${apiStatus.hasApi ? 'âœ… ê³µì‹ API ì‚¬ìš© ê°€ëŠ¥' : 'âŒ ê³µì‹ API ì—†ìŒ'}
- **ìƒì„¸**: ${apiStatus.reason}
- **ê¶Œì¥ ë°©ë²•**: ${apiStatus.hasApi ? 'API ì§ì ‘ ì—°ë™' : 'CSV/ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë°©ì‹'}
` : ''}

## ğŸ¯ WOW íˆ´ íƒ€ì…ë³„ ì ‘ê·¼ë²•
${selectedWowTool.type === 'video_gen' ? `
### ğŸ¬ ì˜ìƒ ìƒì„± ëª¨ë“œ (Runway/HeyGen)
- **ì¶œë ¥ ì¹´ë“œ**: "video_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: ìŠ¤í¬ë¦½íŠ¸ ìµœì í™” + AI ì˜ìƒ + ì‹¤ì‹œê°„ ë Œë”ë§
- **ê²°ê³¼**: MP4 íŒŒì¼ + í¸ì§‘ ê°€ëŠ¥í•œ í”„ë¡œì íŠ¸
` : selectedWowTool.type === 'slide_gen' ? `
### ğŸ“Š ìŠ¬ë¼ì´ë“œ ìƒì„± ëª¨ë“œ (Zenspark/Beautiful.AI)
- **ì¶œë ¥ ì¹´ë“œ**: "slide_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: ë‚´ìš© ìë™ êµ¬ì„± + ë””ìì¸ ìµœì í™” + ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ
- **ê²°ê³¼**: PPT/PDF íŒŒì¼ + ë°œí‘œ ì¤€ë¹„ ì™„ë£Œ
` : selectedWowTool.type === 'landing_gen' ? `
### ğŸŒ ëœë”©í˜ì´ì§€ ìƒì„± ëª¨ë“œ (Durable/Typedream)
- **ì¶œë ¥ ì¹´ë“œ**: "landing_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±  
- **í•µì‹¬**: ì»¨í…ì¸  ìë™í™” + ë””ìì¸ ìµœì í™” + ì¦‰ì‹œ í¼ë¸”ë¦¬ì‹œ
- **ê²°ê³¼**: ë¼ì´ë¸Œ ì›¹ì‚¬ì´íŠ¸ URL + SEO ìµœì í™”
` : selectedWowTool.type === 'dashboard' ? `
### ğŸ“Š ëŒ€ì‹œë³´ë“œ ìƒì„± ëª¨ë“œ (Hex/Metabase)
- **ì¶œë ¥ ì¹´ë“œ**: "dashboard_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: ë°ì´í„° ì—°ê²° + ì‹œê°í™” ìë™í™” + ì‹¤ì‹œê°„ ê³µìœ   
- **ê²°ê³¼**: ì¸í„°ë™í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ URL + ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
` : selectedWowTool.type === 'creative_gen' ? `
### ğŸ¨ í¬ë¦¬ì—ì´í‹°ë¸Œ ìƒì„± ëª¨ë“œ (Bannerbear/Canva)
- **ì¶œë ¥ ì¹´ë“œ**: "creative_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: í…œí”Œë¦¿ ìë™í™” + ì¼ê´„ ìƒì„± + ë¸Œëœë”© ì¼ê´€ì„±
- **ê²°ê³¼**: ë‹¤ìˆ˜ì˜ ë””ìì¸ íŒŒì¼ + ìë™ ë°°í¬
` : selectedWowTool.type === 'audio_gen' ? `
### ğŸµ ì˜¤ë””ì˜¤ ìƒì„± ëª¨ë“œ (ElevenLabs/Murf)
- **ì¶œë ¥ ì¹´ë“œ**: "audio_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: ìŠ¤í¬ë¦½íŠ¸ ìµœì í™” + AI ìŒì„± + ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´
- **ê²°ê³¼**: MP3/WAV íŒŒì¼ + íŒŸìºìŠ¤íŠ¸/ê´‘ê³  í™œìš©
` : selectedWowTool.type === 'chatbot_gen' ? `
### ğŸ’¬ ì±—ë´‡ ìƒì„± ëª¨ë“œ (Landbot/Chatbase)
- **ì¶œë ¥ ì¹´ë“œ**: "chatbot_guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±  
- **í•µì‹¬**: ëŒ€í™” í”Œë¡œìš° + ì§€ì‹ë² ì´ìŠ¤ + ì›¹ì‚¬ì´íŠ¸ ì„ë² ë“œ
- **ê²°ê³¼**: ë¼ì´ë¸Œ ì±—ë´‡ URL + ê³ ê° ì‘ëŒ€ ìë™í™”
` : `
### ğŸ”„ ì›Œí¬í”Œë¡œìš° ëª¨ë“œ (Make/Zapier/Apps Script)
- **ì¶œë ¥ ì¹´ë“œ**: "flow" + "guide" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- **í•µì‹¬**: API ì—°ë™ + ìë™í™” ì›Œí¬í”Œë¡œìš° + ìŠ¤ì¼€ì¤„ë§
- **ê²°ê³¼**: ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ + ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

## â›‘ï¸ Universal Workflow Rules (ì›Œí¬í”Œë¡œìš° íƒ€ì…ìš©)
1. ì²« ë‹¨ê³„ì—ì„œ **engine** ê°’ì„ ë°˜ë“œì‹œ ê²°ì •í•œë‹¤  
   - ê°€ëŠ¥ ê°’: "make" | "zapier" | "apps_script" | "power_automate".
   - ëª¨ë“  step ì€ ë™ì¼ engine ì•ˆì—ì„œ ë™ì‘í•œë‹¤.
2. engine ë³„ 'í•˜ë‚˜ì˜ ì›Œí¬í”Œë¡œ' ëª…ì¹­  
   - make      â†’ Scenario
   - zapier    â†’ Zap
   - apps_script â†’ Script í”„ë¡œì íŠ¸
   - power_automate â†’ Flow
3. **Step 1: í•­ìƒ ìƒˆ ì›Œí¬í”Œë¡œ(Scenario/Zap/Flow) ìƒì„±**ë¶€í„° ì‹œì‘í•˜ê³  ì´ë¦„ì„ ì§€ì‹œí•œë‹¤.
4. ì¶œë ¥ì— **flowMap** ë°°ì—´ì„ í¬í•¨í•´ ëª¨ë“ˆ ì—°ê²° ìˆœì„œë¥¼ ëª…ì‹œí•œë‹¤.  
   ì˜ˆ) "flowMap":["Trigger:Scheduler","CSV-Download","Google Sheets-AddRow","Gmail-Send"]
5. **ê³µì‹ API ìƒíƒœì— ë”°ë¥¸ fallback ì²˜ë¦¬**:  
   ${apiStatus && !apiStatus.hasApi && selectedWowTool.type === 'workflow' ? 
     `"fallback": { "method": "csv_download", "reason": "${apiStatus.reason}" } í¬í•¨` : 
     'API ì—°ë™ ë°©ì‹ ìš°ì„  ì¶”ì²œ'}
6. UI ë¼ë²¨ì€ **êµµê²Œ** (ì˜ˆ: **+ Add another module**) ë¡œ í‘œê¸°í•´ ì‹¤ì œ ë²„íŠ¼ì„ ì°¾ê²Œ í•œë‹¤.

# í•µì‹¬ ì›ì¹™: ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ ê¸°ì¤€ìœ¼ë¡œ AIê°€ ì¶”ì²œ

## ìë™í™” ìˆ˜ì¤€ ë¶„ì„ ê¸°ì¤€:
1. **ë¹ˆë„ ë¶„ì„**: ì¼íšŒì„± vs ì£¼ê¸°ì  vs ì‹¤ì‹œê°„
2. **ë°ì´í„°ëŸ‰**: ì†ŒëŸ‰ vs ì¤‘ê°„ vs ëŒ€ëŸ‰
3. **ë³µì¡ë„**: ë‹¨ìˆœ vs ì¤‘ê°„ vs ë³µì¡
4. **íŒ€ ê·œëª¨**: ê°œì¸ vs íŒ€ vs ì¡°ì§
5. **ê¸°ìˆ  ìˆ˜ì¤€**: ì´ˆë³´ vs ì¤‘ê¸‰ vs ê³ ê¸‰

## ìë™í™” ìˆ˜ì¤€ë³„ íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ:

### ğŸŸ¢ ìˆ˜ë™ ì²˜ë¦¬ (ROI ì¸¡ì • ë‹¨ê³„)
- **íˆ¬ì…**: 30ë¶„-1ì‹œê°„/íšŒ
- **ì ìš©**: ì›” 1-2íšŒ or ì¼íšŒì„± or ë°ì´í„° ì†ŒëŸ‰
- **ì¥ì **: ì¦‰ì‹œ ì‹œì‘, í•™ìŠµ ë¹„ìš© ì—†ìŒ
- **ë‹¨ì **: ë°˜ë³µ ì‹œ ë¹„íš¨ìœ¨

### ğŸŸ¡ ë°˜ìë™í™” (íš¨ìœ¨ì„± ì¦ëŒ€)
- **íˆ¬ì…**: ì„¤ì • 1-2ì‹œê°„ + ì£¼ 5-10ë¶„ ê´€ë¦¬
- **ì ìš©**: ì£¼ 1íšŒ ì´ìƒ or íŒ¨í„´ ë°˜ë³µ or ì¤‘ê°„ ë°ì´í„°ëŸ‰
- **ì¥ì **: 80% ì‹œê°„ ì ˆì•½, ì•ˆì •ì„±
- **ë‹¨ì **: ì´ˆê¸° ì„¤ì • í•„ìš”

### ğŸ”´ ì™„ì „ìë™í™” (ìŠ¤ì¼€ì¼ë§)
- **íˆ¬ì…**: ì„¤ì • 3-5ì‹œê°„ + ì›” 10-20ë¶„ ê´€ë¦¬
- **ì ìš©**: ì¼ì¼ ë°˜ë³µ or ëŒ€ëŸ‰ ë°ì´í„° or íŒ€ ê³µìœ 
- **ì¥ì **: 95% ì‹œê°„ ì ˆì•½, í™•ì¥ì„±
- **ë‹¨ì **: ë†’ì€ ì´ˆê¸° íˆ¬ì

# ë°˜ë“œì‹œ JSON í˜•íƒœë¡œ ì‘ë‹µ (ì¶”ì²œëœ WOW íˆ´ì— ë§ëŠ” ì¹´ë“œ ìƒì„±):

${selectedWowTool.type !== 'workflow' ? `
## ğŸš€ WOW ì „ìš© ì¹´ë“œ í˜•ì‹ (${selectedWowTool.type})
{
  "cards": [
    {
      "type": "tool_recommendation",
      "title": "ğŸ† ë§ì¶¤í˜• WOW ì†”ë£¨ì…˜",
      "subtitle": "${selectedWowTool.name}ë¡œ ${selectedWowTool.setupTime}ë§Œì— ì™„ì„±",
      "selectedTool": {
        "name": "${selectedWowTool.name}",
        "type": "${selectedWowTool.type}",
        "url": "${selectedWowTool.url}",
        "wowScore": ${selectedWowTool.wowScore},
        "reasoning": "í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ ìµœì  ë§¤ì¹­"
      },
      "alternatives": [],
      "selectionCriteria": {
        "userInput": "ì‚¬ìš©ì ì…ë ¥",
        "matchedKeywords": ["ë§¤ì¹­ëœ", "í‚¤ì›Œë“œë“¤"],
        "difficultyPreference": "${selectedWowTool.difficulty}",
        "budgetRange": "${selectedWowTool.pricing}"
      }
    },
    {
      "type": "${selectedWowTool.type === 'slide_gen' ? 'slide_guide' : 
                selectedWowTool.type === 'video_gen' ? 'video_guide' : 
                selectedWowTool.type === 'avatar_video' ? 'video_guide' :
                selectedWowTool.type === 'landing_gen' ? 'landing_guide' :
                selectedWowTool.type === 'dashboard' ? 'dashboard_guide' :
                selectedWowTool.type === 'creative_gen' ? 'creative_guide' :
                selectedWowTool.type === 'audio_gen' ? 'audio_guide' :
                selectedWowTool.type === 'chatbot_gen' ? 'chatbot_guide' : 'guide'}",
      "tool": "${selectedWowTool.name}",
      "title": "ğŸ¯ ${selectedWowTool.name} ì™„ì „ ê°€ì´ë“œ",
      "subtitle": "${selectedWowTool.setupTime}ë§Œì— WOW ê²°ê³¼ ì™„ì„±",
      "detailedSteps": [
        {
          "number": 1,
          "title": "${selectedWowTool.url} ì ‘ì†í•˜ê¸°",
          "description": "ë¸Œë¼ìš°ì €ì—ì„œ ${selectedWowTool.name} ê³µì‹ ì‚¬ì´íŠ¸ ì ‘ì†",
          "expectedScreen": "${selectedWowTool.name} ë©”ì¸ í˜ì´ì§€",
          "checkpoint": "ì‚¬ì´íŠ¸ê°€ ì •ìƒ ë¡œë”©ë˜ì—ˆëŠ”ì§€ í™•ì¸"
        }
      ],
      "estimatedTime": "${selectedWowTool.setupTime}",
      "pricing": "${selectedWowTool.pricing}",
      "commonErrors": []
    }
  ]
}
` : `
## ğŸ”„ ì›Œí¬í”Œë¡œìš° ì¹´ë“œ í˜•ì‹ (ê¸°ì¡´ ë°©ì‹)
{
  "cards": [
    {
      "type": "needs_analysis",
      "title": "ğŸ¯ ì§„ì§œ ë‹ˆì¦ˆ ë°œê²¬",
      "surfaceRequest": "ì‚¬ìš©ìê°€ ë§í•œ ê²ƒ",
      "realNeed": "ì‹¤ì œë¡œ í•„ìš”í•œ ê²ƒ",
      "recommendedLevel": "ìˆ˜ë™/ë°˜ìë™/ì™„ì „ìë™",
      "expectedBenefit": "ì˜ˆìƒ íš¨ê³¼",
      "investmentRequired": "í•„ìš”í•œ íˆ¬ì…",
      "whyThisLevel": "ì´ ìˆ˜ì¤€ì„ ì¶”ì²œí•˜ëŠ” ì´ìœ "
    },
    {
      "type": "flow",
      "title": "ğŸš€ ${selectedWowTool.name} ìë™í™” í”Œë¡œìš°",
      "subtitle": "íˆ¬ì…ëŒ€ë¹„ ì‚°ì¶œ ìµœì í™”ëœ ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íš",
      "engine": "${selectedWowTool.name === 'Make.com' ? 'make' : selectedWowTool.name === 'Zapier' ? 'zapier' : 'apps_script'}",
      "flowMap": ["Trigger:Event", "Process:Data", "Output:Result"],
      "fallback": { "method": "csv_download", "reason": "API ëŒ€ì•ˆ" },
      "steps": [
        {
          "id": "1",
          "icon": "ğŸ”§",
          "title": "êµ¬ì²´ì  ê²°ê³¼ ì¤‘ì‹¬ ë‹¨ê³„ëª…",
          "subtitle": "ì‚¬ìš©ìê°€ ëŠë‚„ í¸ë¦¬í•¨",
          "duration": "ì˜ˆìƒ ì‹œê°„"
        }
      ]
    }
  ]
}`
        },
        {
          role: 'user',
          content: `ì‚¬ìš©ì ì…ë ¥: "${userInput}"
í›„ì† ë‹µë³€: ${JSON.stringify(followupAnswers)}

CRITICAL: ë°˜ë“œì‹œ return_cards í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì¹´ë“œ ë°°ì—´ì„ ë°˜í™˜í•´ì£¼ì„¸ìš”. ë¹ˆ ê°ì²´ë‚˜ ë¹ˆ ë°°ì—´ì€ ì ˆëŒ€ ê¸ˆì§€ì…ë‹ˆë‹¤.`
        }
      ],
      max_tokens: 2000,
      temperature: 0.7
    });

    // 1ë‹¨ê³„ ê²°ê³¼ íŒŒì‹± (Function Calling + Zod ê²€ì¦)
    let stage1Cards: any[] = [];
    try {
      // ğŸ” ë””ë²„ê¹…: ì „ì²´ ì‘ë‹µ êµ¬ì¡° í™•ì¸
      const message = stage1Response.choices[0]?.message;
      console.log(`[DEBUG] ì‘ë‹µ ë©”ì‹œì§€ íƒ€ì…:`, typeof message);
      console.log(`[DEBUG] tool_calls ì¡´ì¬:`, !!message?.tool_calls);
      console.log(`[DEBUG] tool_calls ê¸¸ì´:`, message?.tool_calls?.length || 0);
      console.log(`[DEBUG] content ì¡´ì¬:`, !!message?.content);
      
      const fc = message?.tool_calls?.[0];
      console.log(`[DEBUG] function call:`, fc ? 'YES' : 'NO');
      console.log(`[DEBUG] function name:`, fc?.function?.name);
      
      if (fc?.function?.name === 'return_cards') {
        console.log(`[DEBUG] function arguments:`, fc.function.arguments);
        const parsed = JSON.parse(fc.function.arguments);
        console.log(`[DEBUG] parsed object keys:`, Object.keys(parsed));
        console.log(`[DEBUG] has cards field:`, 'cards' in parsed);
        
        stage1Cards = Stage1ResponseSchema.parse(parsed).cards;
        console.log(`[1ë‹¨ê³„] Function Calling + Zod ê²€ì¦ ì„±ê³µ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${stage1Cards.length}`);
      } else {
        console.warn('[1ë‹¨ê³„] Function Calling ê²°ê³¼ ì—†ìŒ');
        // ğŸ”§ ì¼ë°˜ content ì‘ë‹µ ì‹œ fallback ì‹œë„
        if (message?.content) {
          console.log(`[FALLBACK] content ì‘ë‹µ ì‹œë„:`, message.content.substring(0, 200));
        }
      }
    } catch (error) {
      console.error('[1ë‹¨ê³„] Function Calling + Zod íŒŒì‹± ì˜¤ë¥˜:', error);
      stage1Cards = []; // ì•ˆì „í•œ ê¸°ë³¸ê°’
    }
    
    allCards.push(...stage1Cards);
    console.log(`[1ë‹¨ê³„] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${stage1Cards.length}`);
    
    // engine í†µì¼ì„± ê²€ì¦ ë° flowMap ê²€ì¦
    const initialFlowCard = stage1Cards.find(card => card.type === 'flow');
    if (initialFlowCard) {
      // engine ê²€ì¦
      if (initialFlowCard.engine) {
        console.log(`[engine í†µì¼] ì„ íƒëœ ì—”ì§„:`, initialFlowCard.engine);
      } else {
        console.warn(`[engine ê²½ê³ ] engine ê°’ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ`);
        // engine ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
        initialFlowCard.engine = 'make';
        console.log(`[engine ìë™ì„¤ì •] ê¸°ë³¸ê°’ 'make'ë¡œ ì„¤ì •ë¨`);
      }
      
      // flowMap ê²€ì¦
      if (initialFlowCard.flowMap && Array.isArray(initialFlowCard.flowMap)) {
        console.log(`[flowMap ê²€ì¦] ëª¨ë“ˆ ì—°ê²° ìˆœì„œ:`, initialFlowCard.flowMap);
      } else {
        console.warn(`[flowMap ê²½ê³ ] flowMapì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ`);
        // flowMapì´ ì—†ìœ¼ë©´ ë‹¨ê³„ì—ì„œ ê¸°ë³¸ ìƒì„±
        initialFlowCard.flowMap = initialFlowCard.steps?.map((step: any, i: number) => 
          `Step${i+1}:${step.title.replace(/\s+/g, '-')}`
        ) || [];
        console.log(`[flowMap ìë™ìƒì„±] ê¸°ë³¸ flowMap ìƒì„±:`, initialFlowCard.flowMap);
      }

      // fallback ê²€ì¦
      if (initialFlowCard.fallback) {
        console.log(`[fallback ê²€ì¦] API ëŒ€ì•ˆ ë°©ë²•:`, initialFlowCard.fallback.method, '-', initialFlowCard.fallback.reason);
      }
    }

    // í”Œë¡œìš°ì—ì„œ ë‹¨ê³„ ì¶”ì¶œ
    const flowCard = stage1Cards.find((card: any) => card.type === 'flow');
    const steps = flowCard?.steps || [];
    const selectedEngine = flowCard?.engine || 'make';
    
    // ğŸ¯ ì—”ì§„ í†µì¼ì„± ì²´í¬ + mini ëª¨ë¸ 1íšŒ ì¬í˜¸ì¶œ (ë¹„ìš© ì„¸ì´í”„ê°€ë“œ)
    let retryFlag = false;
    const engineMismatch = (cards: any[], engine: string) => {
      return cards.some(c => c.engine && c.engine !== engine);
    };

    if (engineMismatch(stage1Cards, selectedEngine)) {
      if (!retryFlag) {
        retryFlag = true;
        console.log(`[ì—”ì§„ í†µì¼] ${selectedEngine}ìœ¼ë¡œ í†µì¼ í•„ìš” - mini ëª¨ë¸ 1íšŒ ì¬í˜¸ì¶œ`);
        
        try {
          const miniResponse = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            max_tokens: 300,
            messages: [
              {
                role: 'system',
                content: `ì•„ë˜ JSONì—ì„œ ëª¨ë“  "engine" í•„ë“œë¥¼ "${selectedEngine}"ë¡œ í†µì¼í•´ì£¼ì„¸ìš”. ì¶œë ¥ì€ ìˆ˜ì •ëœ JSON í•œ ë©ì–´ë¦¬ë§Œ, ë‹¤ë¥¸ ì„¤ëª… ê¸ˆì§€.`
              },
              {
                role: 'user', 
                content: JSON.stringify(stage1Cards)
              }
            ]
          });
          
          stage1Cards = JSON.parse(miniResponse.choices[0].message.content || '[]');
          console.log(`[ì—”ì§„ í†µì¼] ì™„ë£Œ - ${selectedEngine}ìœ¼ë¡œ í†µì¼ë¨`);
        } catch (error) {
          console.warn('âš ï¸ ì—”ì§„ í†µì¼ ì‹¤íŒ¨ - ê¸°ì¡´ ì¹´ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©:', error);
        }
      } else {
        console.warn('âš ï¸ ì—”ì§„ ë¶ˆì¼ì¹˜ - ì¬ì‹œë„ ë¶ˆê°€, ìˆ˜ë™ ê²€í†  í•„ìš”');
      }
    }
    
    // ğŸ¯ ë¹„-ì›Œí¬í”Œë¡œ íƒ€ì…ì¼ ë•Œ Stage-2 ì¦‰ì‹œ return (í† í° 50-80% ì ˆì•½)
    const isWorkflow = selectedWowTool.type === 'workflow';
    if (!isWorkflow) {
      console.log(`ğŸ”• Stage-2 skip (non-workflow) - ${selectedWowTool.type} íƒ€ì…`);
      
      // ì¹´ë“œ ê·¸ëŒ€ë¡œ ì¢…ë£Œ
      allCards.push(...stage1Cards);
      
      const processingTime = Date.now() - startTime;
      const response_data = {
        cards: allCards,
        metadata: {
          generatedAt: new Date().toISOString(),
          processingTime: processingTime,
          approach: 'WOW_íƒ€ì…_1ë‹¨ê³„ë§Œ',
          stages: {
            stage1: 'gpt-4o-2024-11-20 (WOW ê°€ì´ë“œ)',
            stage2: 'SKIPPED (non-workflow)',
            stage3: 'SKIPPED (non-workflow)'
          },
          costOptimization: '80%ì ˆì•½ (Stage-2,3 ìƒëµ)',
          speedOptimization: 'ì¦‰ì‹œ ì‘ë‹µ',
          toolType: selectedWowTool.type
        }
      };
      
      return NextResponse.json(response_data);
    }
    
    // â†“ ì—¬ê¸°ë¶€í„°ëŠ” workflow ì „ìš© ë£¨í”„
    console.log(`[2ë‹¨ê³„] ì›Œí¬í”Œë¡œìš° íƒ€ì… - ${steps.length}ê°œ ë‹¨ê³„ì— ëŒ€í•œ ìƒì„¸ ê°€ì´ë“œ ìƒì„±`);
    console.log(`[2ë‹¨ê³„] ìƒì„±ëœ ë‹¨ê³„ë“¤:`, steps.map((s: any) => `${s.id}. ${s.title}`));

    // ğŸ”„ 2ë‹¨ê³„: ê° ë‹¨ê³„ë³„ ìƒì„¸ ê°€ì´ë“œ ìƒì„± (gpt-4o-2024-11-20 - ìµœê³  í’ˆì§ˆ)
    const guideCards = [];
    
    // 1ë‹¨ê³„ì™€ 2ë‹¨ê³„ ì‚¬ì´ RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•œ ë”œë ˆì´
    console.log(`[2ë‹¨ê³„] 1ë‹¨ê³„ ì™„ë£Œ í›„ RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸°...`);
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    for (let i = 0; i < steps.length; i++) {
      const step = steps[i];
      console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ê°€ì´ë“œ ìƒì„±: ${step.title} (stepId: ${step.id})`);
      
      // RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸° (ê¸°ì¡´ 2ì´ˆ â†’ 1ì´ˆ ìµœì í™”)
      if (i > 0) {
        console.log(`[2ë‹¨ê³„] RPM í•œë„ íšŒí”¼ë¥¼ ìœ„í•´ 1ì´ˆ ëŒ€ê¸°...`);
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      // ì´ì „ ë‹¨ê³„ë“¤ì˜ ê²°ê³¼ë¬¼ ìˆ˜ì§‘
      const previousSteps = steps.slice(0, i);
      const previousGuides = guideCards.filter(card => 
        previousSteps.some((prevStep: any) => prevStep.id === card.stepId)
      );

      try {
        console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ê°€ì´ë“œ ìƒì„±: ${step.title} (stepId: ${step.id})`);
        
        const guideResponse = await openai.chat.completions.create({
          model: 'gpt-4o-2024-11-20',
          messages: [
            {
              role: 'system',
              content: `ë‹¹ì‹ ì€ ì´ˆë³´ìë„ 100% ë”°ë¼í•  ìˆ˜ ìˆëŠ” ìë™í™” ê°€ì´ë“œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

# ë°˜ë“œì‹œ ì •í™•í•œ JSON í˜•íƒœë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "cards": [
    {
      "type": "guide",
      "stepId": "${step.id}",
      "title": "${step.title}",
      "subtitle": "ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆëŠ” ì„¤ëª…",
      "basicConcept": "ì´ ë‹¨ê³„ì˜ ëª©ì ê³¼ í•„ìš”ì„±ì„ ê°„ë‹¨íˆ ì„¤ëª…",
      "automationLevel": "ìˆ˜ë™",
      "ecosystem": "make",
      "content": {
        "fromPreviousStep": "ì´ì „ ë‹¨ê³„ì—ì„œ ë§Œë“  ê²ƒì„ í™œìš©í•©ë‹ˆë‹¤",
        "toolChoice": {
          "recommended": "Make.com",
          "reason": "ì´ˆë³´ìë„ ì‚¬ìš©í•˜ê¸° ì‰½ê³  ì•ˆì •ì ì…ë‹ˆë‹¤"
        },
        "detailedSteps": [
          {
            "number": 1,
            "title": "êµ¬ì²´ì ì¸ ì²« ë²ˆì§¸ ì‘ì—…",
            "description": "1. **ë¸Œë¼ìš°ì €**ì—ì„œ Make.com ì ‘ì†\\n2. **ìƒˆ ì‹œë‚˜ë¦¬ì˜¤** ë²„íŠ¼ í´ë¦­\\n3. ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤",
            "expectedScreen": "Make.com ëŒ€ì‹œë³´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤",
            "checkpoint": "ì‹œë‚˜ë¦¬ì˜¤ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸"
          }
        ],
        "importBlocks": {
          "make_import_json": "{\\"scenario\\": \\"example\\"}",
          "sheet_header_csv": "ì´ë¦„,ì´ë©”ì¼,ë‚ ì§œ"
        },
        "commonErrors": [
          {
            "code": "ì—°ê²° ì˜¤ë¥˜",
            "cause": "API í‚¤ê°€ ì˜ëª»ë¨",
            "fix": "API í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”"
          }
        ],
        "successCheck": "ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”"
      }
    }
  ]
}

âš ï¸ ì¤‘ìš”: ë°˜ë“œì‹œ ìœ„ í˜•ì‹ì˜ ì™„ì „í•œ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”. ì„¤ëª…ì´ë‚˜ ì¶”ê°€ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`
            },
            {
              role: 'user',
              content: `
í˜„ì¬ ë‹¨ê³„: ${step.title} (${step.id}ë²ˆì§¸)
ì „ì²´ ëª©í‘œ: ${userInput}
ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(followupAnswers || {})}
ì„ íƒëœ ì—”ì§„: ${selectedEngine}
ì „ì²´ í”Œë¡œìš°ë§µ: ${JSON.stringify(flowCard?.flowMap || [])}

ì´ ë‹¨ê³„ëŠ” "${selectedEngine}" ì—”ì§„ì˜ ê¸°ì¡´ ì›Œí¬í”Œë¡œ ë‚´ì—ì„œ "+ëª¨ë“ˆ ì¶”ê°€" ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤/Zapì„ ë§Œë“¤ì§€ ë§ê³ , ê¸°ì¡´ ì›Œí¬í”Œë¡œì—ì„œ ëª¨ë“ˆë§Œ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì•ˆë‚´í•˜ì„¸ìš”.
`
            }
          ],
        max_tokens: 2000,
          temperature: 0.3
        });

        const content = guideResponse.choices[0]?.message?.content?.trim();
        if (!content) {
          throw new Error('ì‘ë‹µ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤');
        }

        // JSON ì¶”ì¶œ ë° ì •ë¦¬
        let jsonContent = content;
        
        // ì½”ë“œ ë¸”ë¡ ì œê±°
        if (jsonContent.includes('```json')) {
          const match = jsonContent.match(/```json\s*([\s\S]*?)\s*```/);
          if (match) {
            jsonContent = match[1];
          }
        } else if (jsonContent.includes('```')) {
          const match = jsonContent.match(/```\s*([\s\S]*?)\s*```/);
          if (match) {
            jsonContent = match[1];
          }
        }
        
        // ë¬¸ìì—´ ì •ë¦¬
        jsonContent = jsonContent.trim();

        console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ì‘ë‹µ ê¸¸ì´:`, content.length);

        try {
          const parsed = JSON.parse(jsonContent);
          
          if (parsed.cards && Array.isArray(parsed.cards) && parsed.cards.length > 0) {
            const stepGuides = parsed.cards.filter((card: any) => card.type === 'guide');
            
            // í•„ìˆ˜ í•„ë“œ ë³´ì™„ (engine ì •ë³´ ì „ë‹¬)
            stepGuides.forEach((guide: any) => {
              if (!guide.engine) {
                guide.engine = selectedEngine;
              }
              
              if (!guide.content.importBlocks) {
                guide.content.importBlocks = {
                  make_import_json: `{"scenario": "${step.title}_automation"}`,
                  sheet_header_csv: "í•­ëª©,ê°’,ë‚ ì§œ"
                };
              }
              
              if (!guide.content.commonErrors) {
                guide.content.commonErrors = [
                  {
                    code: "ì—°ê²° ì‹¤íŒ¨",
                    cause: "ì¸í„°ë„· ì—°ê²° ë˜ëŠ” API ë¬¸ì œ",
                    fix: "ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”"
                  }
                ];
              }
            });
            
            guideCards.push(...stepGuides);
            console.log(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ê°€ì´ë“œ ìƒì„± ì™„ë£Œ (${stepGuides.length}ê°œ ì¹´ë“œ)`);
          } else {
            throw new Error('ìœ íš¨í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (parseError) {
          console.error(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ íŒŒì‹± ì˜¤ë¥˜:`, parseError);
          
          // ê¸°ë³¸ ê°€ì´ë“œ ìƒì„±
          guideCards.push({
            type: 'guide',
            stepId: step.id.toString(),
            title: step.title,
            subtitle: 'ê¸°ë³¸ ê°€ì´ë“œ',
            basicConcept: 'ì´ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ê°€ì´ë“œì…ë‹ˆë‹¤.',
            automationLevel: 'ìˆ˜ë™',
            ecosystem: 'manual',
            content: {
              fromPreviousStep: 'ì´ì „ ë‹¨ê³„ì˜ ê²°ê³¼ë¥¼ í™œìš©í•©ë‹ˆë‹¤',
              toolChoice: {
                recommended: 'ìˆ˜ë™ ì‘ì—…',
                reason: 'ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•ì…ë‹ˆë‹¤'
              },
              detailedSteps: [{
                number: 1,
                title: step.title,
                description: 'ë‹¨ê³„ë³„ë¡œ ì§„í–‰í•˜ì„¸ìš”',
                expectedScreen: 'ì •ìƒì ì¸ í™”ë©´',
                checkpoint: 'ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸'
              }],
              importBlocks: {
                make_import_json: '{"scenario": "basic"}',
                sheet_header_csv: 'í•­ëª©,ê°’'
              },
              commonErrors: [{
                code: 'ì¼ë°˜ ì˜¤ë¥˜',
                cause: 'ì„¤ì • ë¬¸ì œ',
                fix: 'ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”'
              }],
              successCheck: 'ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”'
            }
          });
        }
      } catch (error) {
        console.error(`[2ë‹¨ê³„] ${i + 1}ë²ˆì§¸ ë‹¨ê³„ ìƒì„± ì˜¤ë¥˜:`, error);
        
        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ê°€ì´ë“œ ìƒì„±
        guideCards.push({
          type: 'guide',
          stepId: step.id.toString(),
          title: step.title,
          subtitle: 'ì˜¤ë¥˜ ë°œìƒ',
          basicConcept: 'ê°€ì´ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          automationLevel: 'ìˆ˜ë™',
          ecosystem: 'manual',
          content: {
            fromPreviousStep: 'ì´ì „ ë‹¨ê³„ ì—°ê²°',
            toolChoice: {
              recommended: 'ìˆ˜ë™ ì‘ì—…',
              reason: 'ì˜¤ë¥˜ë¡œ ì¸í•œ ê¸°ë³¸ê°’'
            },
            detailedSteps: [{
              number: 1,
              title: 'ì¬ì‹œë„ í•„ìš”',
              description: 'í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”',
              expectedScreen: 'ì •ìƒ í™”ë©´',
              checkpoint: 'ì„¤ì • í™•ì¸'
            }],
            importBlocks: {
              make_import_json: '{"scenario": "basic"}',
              sheet_header_csv: 'í•­ëª©,ê°’'
            },
            commonErrors: [{
              code: 'ìƒì„± ì˜¤ë¥˜',
              cause: 'API ë¬¸ì œ',
              fix: 'ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”'
            }],
            successCheck: 'ì •ìƒ ë™ì‘ í™•ì¸'
          }
        });
      }
    }

    allCards.push(...guideCards);
    console.log(`[2ë‹¨ê³„] ìµœì¢… ìƒì„±ëœ ê°€ì´ë“œ ì¹´ë“œ ìˆ˜: ${guideCards.length}/${steps.length}`);
        console.log(`[2ë‹¨ê³„] ìƒì„±ëœ ê°€ì´ë“œ ì¹´ë“œë“¤:`, guideCards.map((card: any) => ({
          stepId: card.stepId,
          title: card.title,
      hasDetailedSteps: !!(card.content?.detailedSteps?.length > 0)
        })));

    // ğŸ”„ 3ë‹¨ê³„: FAQ + í™•ì¥ ì•„ì´ë””ì–´ (gpt-4o-mini - ë¹„ìš©ì ˆì•½)
    console.log('[3ë‹¨ê³„] FAQ + í™•ì¥ ì•„ì´ë””ì–´ (gpt-4o-mini - ë¹„ìš©ì ˆì•½)');
    const stage3Response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `ë‹¹ì‹ ì€ ì‹¤ì „ ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. FAQì™€ í™•ì¥ ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•˜ì„¸ìš”.

# ë°˜ë“œì‹œ JSON í˜•íƒœë¡œ ì‘ë‹µ:
{
  "cards": [
    {
      "type": "faq",
      "title": "â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸",
      "items": [
        {
          "question": "ì‹¤ì œ ìƒí™©ë³„ ì§ˆë¬¸",
          "answer": "êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‹µë³€"
        }
      ]
    },
    {
      "type": "expansion", 
      "title": "ğŸš€ í™•ì¥ ì•„ì´ë””ì–´",
      "subtitle": "ë” í° ê°€ì¹˜ ì°½ì¶œ",
      "possibilities": [
        "í˜„ì¬ ìë™í™”ë¥¼ ë” í° ì‹œìŠ¤í…œìœ¼ë¡œ í™•ì¥í•˜ëŠ” ë°©ë²•ë“¤ (AI ë„êµ¬ í™œìš© ì¤‘ì‹¬)"
      ],
      "futureVision": [
        "GPT-4o/Claude 3.5 Sonnet ë“± ìµœì‹  AIë¡œ ë” ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë°œì „ì‹œí‚¤ëŠ” ë°©í–¥"
      ]
    },
    {
      "type": "method_recommendation",
      "title": "ğŸ› ï¸ ì¶”ì²œ ë°©ë²•",
      "subtitle": "ìƒí™©ë³„ ìµœì  ë°©ë²•",
      "methods": [
        {
          "name": "ë°©ë²•ëª…",
          "description": "ì„¤ëª…",
          "pros": ["ì¥ì ë“¤"],
          "cons": ["ë‹¨ì ë“¤"],
          "difficulty": "ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€"
        }
      ]
    },
    {
      "type": "share",
      "title": "ğŸ“¤ ê³µìœ í•˜ê¸°",
      "subtitle": "ê²°ê³¼ ê³µìœ  ë° í˜‘ì—…",
      "shareOptions": [
        "ê³µìœ  ë°©ë²•ë“¤"
      ]
    }
  ]
}`
        },
        {
          role: 'user',
          content: `
ì „ì²´ ëª©í‘œ: ${userInput}
ìƒì„±ëœ í”Œë¡œìš°: ${JSON.stringify(flowCard?.steps || [])}
í›„ì† ë‹µë³€: ${JSON.stringify(followupAnswers || {})}

# ğŸ› ï¸ ë‹¤ì–‘í•œ ì†”ë£¨ì…˜ ì ‘ê·¼ë²• ì¤‘ì‹¬ ì§€ì¹¨:

## FAQ ì‘ì„± ì‹œ:
- "ê¸°ìˆ ì  ì§€ì‹ì´ ì—†ì–´ë„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€?"
- "ì˜ˆì‚°ì´ ì œí•œì ì¼ ë•Œ ë¬´ë£Œë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì€?"
- "ê¸°ì¡´ ë„êµ¬(ë…¸ì…˜, ì—‘ì…€ ë“±)ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ëŠ” ë°©ë²•ì€?"
- "íšŒì‚¬ ë³´ì•ˆ ì •ì±… ë•Œë¬¸ì— ì™¸ë¶€ ë„êµ¬ë¥¼ ëª» ì“¸ ë•ŒëŠ”?"

## í™•ì¥ ì•„ì´ë””ì–´ ì‘ì„± ì‹œ:
- **í˜„ì¬ ë°©ë²• â†’ ë” ìŠ¤ë§ˆíŠ¸í•œ ë°©ë²•ë“¤**ë¡œ ë‹¨ê³„ë³„ ë°œì „
- **ê°œì¸ ì‚¬ìš© â†’ íŒ€ í˜‘ì—… â†’ ì¡°ì§ ì „ì²´ ì‹œìŠ¤í…œ**
- **ìˆ˜ë™ ì²˜ë¦¬ â†’ ë°˜ìë™ â†’ ì™„ì „ ìë™**
- **ì¼íšŒì„± â†’ ì§€ì†ì  ëª¨ë‹ˆí„°ë§ â†’ ì˜ˆì¸¡ ê¸°ëŠ¥**

## ì¶”ì²œ ë°©ë²• ì‘ì„± ì‹œ (ìµœì  ë°©ë²• 1ê°œ + ê°„ë‹¨í•œ ëŒ€ì•ˆ 1-2ê°œ):
- **ğŸ† ìµœì  ë°©ë²•**: í›„ì†ë‹µë³€ ê¸°ë°˜ìœ¼ë¡œ ì´ ì‚¬ìš©ìì—ê²Œ ê°€ì¥ ì í•©í•œ ë°©ë²•
- **ğŸ”„ ê°„ë‹¨í•œ ëŒ€ì•ˆ**: 1-2ê°œì˜ ëŒ€ì•ˆë§Œ ê°„ëµíˆ ì œì‹œ
- **âŒ ì•ˆ ì¶”ì²œí•˜ëŠ” ë°©ë²•**: ì™œ ë‹¤ë¥¸ ë°©ë²•ë“¤ì€ ì´ ì‚¬ìš©ìì—ê²Œ ì í•©í•˜ì§€ ì•Šì€ì§€

ì‹¤ì „ FAQ, í™•ì¥ ì•„ì´ë””ì–´, ì¶”ì²œ ë°©ë²•, ê³µìœ  ì˜µì…˜ì„ ìƒì„±í•˜ì„¸ìš”.
`
        }
      ],
      max_tokens: 1500,
      temperature: 0.7
    });

    // 3ë‹¨ê³„ ê²°ê³¼ íŒŒì‹±
    const stage3Content = stage3Response.choices[0]?.message?.content;
    try {
      if (stage3Content) {
        const jsonMatch = stage3Content.match(/```json\s*([\s\S]*?)\s*```/);
        const jsonContent = jsonMatch ? jsonMatch[1] : stage3Content;
        const parsed = JSON.parse(jsonContent);
        const stage3Cards = parsed.cards || [];
        allCards.push(...stage3Cards);
        console.log(`[3ë‹¨ê³„] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${stage3Cards.length}`);
      }
    } catch (error) {
      console.error('[3ë‹¨ê³„] íŒŒì‹± ì˜¤ë¥˜:', error);
    }

    const processingTime = Date.now() - startTime;
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] ì™„ë£Œ - ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${allCards.length}`);
    console.log(`[ğŸ’° ë¹„ìš© ìµœì í™”] 1ë‹¨ê³„: gpt-4o-2024-11-20 ($2.50/$10.00), 2ë‹¨ê³„: gpt-4o-2024-11-20 ($2.50/$10.00), 3ë‹¨ê³„: gpt-4o-mini ($0.15/$0.60)`);
    console.log(`[âš¡ ì†ë„ ìµœì í™”] 1,2ë‹¨ê³„: 1ì´ˆë”œë ˆì´ (4o RPMí•œë„ íšŒí”¼), 3ë‹¨ê³„: ë¹ ë¥¸ì‘ë‹µ (mini ë†’ì€RPM)`);
    console.log(`[ğŸ¨ í’ˆì§ˆ ìµœì í™”] í”Œë¡œìš°+ê°€ì´ë“œëŠ” ìµœê³ í’ˆì§ˆ ëª¨ë¸, FAQë§Œ íš¨ìœ¨ì  ì²˜ë¦¬`);
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] [ìµœì¢… cards ìˆ˜]: ${allCards.length}`);
    console.log(`[í•˜ì´ë¸Œë¦¬ë“œ] [ì¹´ë“œ íƒ€ì…ë“¤]:`, allCards.map((card: any) => card.type));

    // ğŸ¯ ë©”íƒ€ë°ì´í„° ì¶”ê°€
    const response_data = {
      cards: allCards,
      metadata: {
        generatedAt: new Date().toISOString(),
        processingTime: processingTime,
        approach: '3ë‹¨ê³„_í•˜ì´ë¸Œë¦¬ë“œ_ìµœì í™”',
        stages: {
          stage1: 'gpt-4o-2024-11-20 (ë‹ˆì¦ˆ+í”Œë¡œìš°)',
          stage2: 'gpt-4o-2024-11-20 (ìƒì„¸ê°€ì´ë“œ)',
          stage3: 'gpt-4o-mini (FAQ+í™•ì¥)'
        },
        costOptimization: '33%ì ˆì•½ (FAQë§Œ mini ì‚¬ìš©)',
        speedOptimization: '1ì´ˆëŒ€ê¸° (4o RPMí•œë„ íšŒí”¼)',
        qualityMaintained: 'í”Œë¡œìš°+ê°€ì´ë“œëŠ” ìµœê³ í’ˆì§ˆ ìœ ì§€'
      }
    };

    return NextResponse.json(response_data);

  } catch (error) {
    console.error('âŒ ìë™í™” ìƒì„± ì‹¤íŒ¨:', error);
    return handleApiError(error);
  }
} 
