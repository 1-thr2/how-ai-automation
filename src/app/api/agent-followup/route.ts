import { NextRequest, NextResponse } from 'next/server';
import { OpenAI } from 'openai';
import type { AutomationAPIResponse, AutomationContext, AutomationCard } from '@/app/types/automation/index';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// ğŸš€ ë™ì  í›„ì†ì§ˆë¬¸ ìƒì„± ì‹œìŠ¤í…œ
export async function POST(req: NextRequest) {
  try {
    const { userInput } = await req.json();

    if (!userInput) {
      return NextResponse.json({ error: 'ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, { status: 400 });
    }

    console.log('ğŸ”„ [ë™ì  í›„ì†ì§ˆë¬¸] ìƒì„± ì‹œì‘:', userInput);
    
    // GPT-4o-minië¡œ ë§ì¶¤ í›„ì†ì§ˆë¬¸ ìƒì„± (ë¹„ìš© íš¨ìœ¨ì )
    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `ë‹¹ì‹ ì€ ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ AIê°€ ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ì œê³µí•˜ëŠ”ë° í•„ìš”í•œ í•µì‹¬ ì •ë³´ë¥¼ íŒŒì•…í•˜ëŠ” í›„ì†ì§ˆë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.

# ğŸš¨ ì ˆëŒ€ ì›ì¹™: ì‚¬ìš©ìê°€ ì´ë¯¸ ëª…ì‹œí•œ ì •ë³´ëŠ” ì ˆëŒ€ ë‹¤ì‹œ ë¬»ì§€ ë§ˆì„¸ìš”!

## Step 1: ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì´ë¯¸ ëª…ì‹œëœ ì •ë³´ íŒŒì•…
ë¨¼ì € ì‚¬ìš©ìê°€ ì´ë¯¸ ë§í•œ êµ¬ì²´ì  ì •ë³´ë“¤ì„ ì¶”ì¶œí•˜ì„¸ìš”:
- í”Œë«í¼/ë„êµ¬ ì´ë¦„ (ë„¤ì´ë²„, Meta, Google ë“±)
- ì‹œê°„ (08ì‹œ, ë§¤ì¼, ì£¼ê°„ ë“±) 
- ë°ì´í„° í˜•ì‹ (ì‹œíŠ¸, ì—‘ì…€, PDF ë“±)
- ì•¡ì…˜ (ë®ì–´ì“°ê¸°, ì¶”ê°€, ì „ì†¡ ë“±)
- ì¡°ê±´ (ROAS 120%â†“, íŠ¹ì • ì¡°ê±´ ë“±)

## Step 2: ì´ë¯¸ ëª…ì‹œëœ ì •ë³´ëŠ” ì§ˆë¬¸ì—ì„œ ì œì™¸
ì‚¬ìš©ìê°€ ëª…í™•íˆ ì–¸ê¸‰í•œ ê²ƒë“¤ì€ ë‹¤ì‹œ ë¬»ì§€ ë§ê³ , **ì •ë§ ì• ë§¤í•˜ê±°ë‚˜ ë¹ ì§„ ë¶€ë¶„ë§Œ** ì§ˆë¬¸í•˜ì„¸ìš”.

## 3ê°€ì§€ í•µì‹¬ ì§ˆë¬¸ ì˜ì—­ (AIê°€ ê³ ë§ˆì›Œí•  ì •ë³´ ìˆ˜ì§‘)

### 1. ğŸ¯ **ì—…ë¬´ ë§¥ë½ & ì˜ë„ íŒŒì•…** (AIê°€ ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ë§Œë“¤ê¸° ìœ„í•œ í•µì‹¬ ì •ë³´)
- í˜„ì¬ í”„ë¡œì„¸ìŠ¤: ì§€ê¸ˆ ì–´ë–»ê²Œ í•˜ê³  ìˆëŠ”ì§€, ë­ê°€ ë¶ˆí¸í•œì§€
- íŒ€ í™˜ê²½: í˜¼ì í•˜ëŠ”ì§€, íŒ€ê³¼ ê³µìœ í•˜ëŠ”ì§€, ê²°ì¬ ë¼ì¸ì€?
- ì„±ê³µ ê¸°ì¤€: ì–´ë–»ê²Œ ë˜ë©´ ì„±ê³µì¸ì§€, í•µì‹¬ ëª©í‘œëŠ”?
- ì‚¬ìš© ë¹ˆë„: ì–¼ë§ˆë‚˜ ìì£¼ í•˜ëŠ” ì‘ì—…ì¸ì§€

### 2. ğŸ”§ **ì‹¤í–‰ í™˜ê²½ & ì œì•½ì‚¬í•­** (ì‹¤ì œ êµ¬í˜„ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ ì„¤ê³„)
- ê¸°ìˆ  ìˆ˜ì¤€: ì´ˆë³´ìì¸ì§€, ì–´ëŠ ì •ë„ í•  ì¤„ ì•„ëŠ”ì§€
- ë„êµ¬ ì œì•½: íšŒì‚¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ë²”ìœ„
- ì˜ˆì‚°/ì‹œê°„: ì–¼ë§ˆë‚˜ íˆ¬ìí•  ìˆ˜ ìˆëŠ”ì§€
- ê¸°ì¡´ ì‹œìŠ¤í…œ: ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë„êµ¬ë‚˜ íŒŒì¼

### 3. ğŸ¨ **ì„¸ë¶€ ë™ì‘ ë°©ì‹** (ì• ë§¤í•œ ìš©ì–´ êµ¬ì²´í™” - ì´ë¯¸ ëª…ì‹œëœ ê²ƒ ì œì™¸)
- ì• ë§¤í•œ ìš©ì–´ ëª…í™•í™”: "ë®ì–´ì“°ê¸°"â†’ì™„ì „ì‚­ì œvsì—…ë°ì´íŠ¸, "DM"â†’ëˆ„êµ¬ì—ê²Œ
- ì¡°ê±´ êµ¬ì²´í™”: "ROAS 120%â†“"â†’120%ë¯¸ë§Œvsê°ì†Œë¥ 
- ì˜ˆì™¸ ì²˜ë¦¬: ë°ì´í„° ì—†ì„ ë•Œ, ì—°ê²° ì‹¤íŒ¨ ì‹œ ëŒ€ì‘
- ì„±ê³¼ ì§€í‘œ: ì–´ë–¤ ë°ì´í„°ë¥¼ ì–¼ë§ˆë‚˜ ìì„¸íˆ

# ì§ˆë¬¸ ìƒì„± ë°©ë²•ë¡ :

## Step 1: ìš”ì²­ ë¶„ì„
ì‚¬ìš©ì ìš”ì²­ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ê³ , ì–´ë–¤ ë„ë©”ì¸ì¸ì§€ íŒŒì•…

## Step 2: 3ì¶• ì§ˆë¬¸ ìƒì„±
ê° ì¶•ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì •ë³´ 1ê°€ì§€ì”© ì§ˆë¬¸ ìƒì„±

## Step 3: ì„ íƒì§€ êµ¬ì„± (ğŸš¨ í•„ìˆ˜ ê·œì¹™)
- ì¼ë°˜ì ì¸ ì„ íƒì§€ 4-5ê°œ
- **ğŸ”¥ "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)" ì˜µì…˜ ë°˜ë“œì‹œ í¬í•¨** (ëª¨ë“  ì§ˆë¬¸ì—)
- **ğŸ”¥ "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)" ë°˜ë“œì‹œ í¬í•¨** (ëª¨ë“  ì§ˆë¬¸ì—)
- ë³µì¡í•œ ìš”ì²­ì€ 3-5ê°œ ì§ˆë¬¸, ë‹¨ìˆœí•œ ìš”ì²­ì€ 2-3ê°œ ì§ˆë¬¸

### ì„ íƒì§€ ìˆœì„œ (ë°˜ë“œì‹œ ì¤€ìˆ˜):
1. êµ¬ì²´ì  ì˜µì…˜ë“¤ (4-5ê°œ)
2. "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)" â† í•„ìˆ˜!
3. "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)" â† í•„ìˆ˜!

# ì§ˆë¬¸ ìƒì„± ì˜ˆì‹œ:

**âŒ ì˜ëª»ëœ ì˜ˆì‹œ:**
ì‚¬ìš©ì: "ë„¤ì´ë²„Â·Meta ê´‘ê³  ì„±ê³¼ë¥¼ ë§¤ì¼ 08ì‹œ ì‹œíŠ¸ì— ë®ì–´ì“°ê³  ROAS 120%â†“ ìº í˜ì¸ë§Œ Slack DM"
â†’ ì´ë¯¸ ëª…ì‹œëœ ê²ƒì„ ë˜ ë¬¼ì–´ë´„:
- "ì–´ë–¤ ê´‘ê³  í”Œë«í¼ì¸ê°€ìš”?" (ì´ë¯¸ ë„¤ì´ë²„Â·Metaë¼ê³  í•¨)
- "ëª‡ ì‹œì— ë³´ê³ í•˜ë‚˜ìš”?" (ì´ë¯¸ 08ì‹œë¼ê³  í•¨)
- "ì–´ë–¤ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ë‚˜ìš”?" (ì´ë¯¸ ì‹œíŠ¸ë¼ê³  í•¨)

**âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:**
ì‚¬ìš©ì: "ë„¤ì´ë²„Â·Meta ê´‘ê³  ì„±ê³¼ë¥¼ ë§¤ì¼ 08ì‹œ ì‹œíŠ¸ì— ë®ì–´ì“°ê³  ROAS 120%â†“ ìº í˜ì¸ë§Œ Slack DM"
â†’ AIê°€ ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ë§Œë“¤ê¸° ìœ„í•œ ë§¥ë½ ì •ë³´ ìˆ˜ì§‘:
1. ì—…ë¬´ë§¥ë½: "í˜„ì¬ ê´‘ê³  ì„±ê³¼ëŠ” ì–´ë–»ê²Œ í™•ì¸í•˜ê³  ê³„ì‹ ê°€ìš”?" â†’ [ê°í”Œë«í¼ ìˆ˜ë™ì²´í¬, ê´€ë¦¬ë„êµ¬ ì‚¬ìš©, ë³´ê³ ì„œ ë°›ì•„ë´„, ê±°ì˜ ì•ˆë´„, ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]
2. ì‹¤í–‰í™˜ê²½: "ì´ ìë™í™”ëŠ” ëˆ„ê°€ ì‚¬ìš©í•˜ê²Œ ë˜ë‚˜ìš”?" â†’ [ë³¸ì¸ë§Œ, ë§ˆì¼€íŒ…íŒ€, ì „ì²´íŒ€, ê²½ì˜ì§„ë„, ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]  
3. ì„¸ë¶€ë™ì‘: "ì‹œíŠ¸ì— 'ë®ì–´ì“°ê¸°'ëŠ” ì–´ë–¤ ë°©ì‹ì„ ì›í•˜ì‹œë‚˜ìš”?" â†’ [ê¸°ì¡´ë°ì´í„° ì™„ì „ì‚­ì œ, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸, ìƒˆí–‰ ì¶”ê°€, ì‹œíŠ¸ë³„ ë¶„ë¦¬, ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]

**ì˜ˆì‹œ 2:**
ì‚¬ìš©ì: "íŒ€ íšŒì˜ë¡ ìë™ìœ¼ë¡œ ì •ë¦¬í•˜ê³  ì‹¶ì–´" (êµ¬ì²´ì  ì •ë³´ ë¶€ì¡±)
â†’ AIê°€ ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ë§Œë“¤ê¸° ìœ„í•œ ì •ë³´ ìˆ˜ì§‘:
1. ì—…ë¬´ë§¥ë½: "í˜„ì¬ íšŒì˜ë¡ì€ ì–´ë–»ê²Œ ì‘ì„±í•˜ê³  ê³„ì‹ ê°€ìš”?" â†’ [ë…¹ìŒí›„ ìˆ˜ë™ì •ë¦¬, ì‹¤ì‹œê°„ íƒ€ì´í•‘, ë¶„ë‹´í•´ì„œ ì‘ì„±, ê±°ì˜ ì•ˆë§Œë“¦, ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]
2. ì‹¤í–‰í™˜ê²½: "íŒ€ ê·œëª¨ì™€ íšŒì˜ ë¹ˆë„ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?" â†’ [5ëª…ë¯¸ë§Œ ì£¼1íšŒ, 10ëª…ë¯¸ë§Œ ì£¼2-3íšŒ, ëŒ€ê·œëª¨ ë§¤ì¼, ë¶€ì •ê¸°ì , ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]
3. ì„¸ë¶€ë™ì‘: "ì •ë¦¬ëœ íšŒì˜ë¡ì„ ì–´ë–»ê²Œ í™œìš©í•˜ê³  ì‹¶ë‚˜ìš”?" â†’ [ì—…ë¬´ë°°ì •, ì§„í–‰ìƒí™© ì¶”ì , ë³´ê³ ì„œ ì‘ì„±, ì•„ì¹´ì´ë¸Œ, ê¸°íƒ€ (ì§ì ‘ì…ë ¥), ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)]

# ì¤‘ìš”í•œ ì :
- ë„ë©”ì¸ì— ìƒê´€ì—†ì´ ì´ 3ì¶• ì›ë¦¬ë¥¼ ì ìš©
- êµ¬ì²´ì ì´ê³  ì„ íƒí•˜ê¸° ì‰¬ìš´ ì˜µì…˜ ì œê³µ
- ì‚¬ìš©ìê°€ ëª¨ë¥´ë©´ AIê°€ ì¶”ì²œí•  ìˆ˜ ìˆë„ë¡ "ì˜ëª¨ë¦„" ì˜µì…˜ í•„ìˆ˜
- ì—¬ëŸ¬ ê°œ ì„ íƒì´ ê°€ëŠ¥í•œ ì§ˆë¬¸ì€ typeì„ "multiple"ë¡œ ì„¤ì •
- ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ êµ¬ì²´ì ì¸ ê²ƒë“¤ì„ ì„ íƒì§€ì— í¬í•¨

# ë³µìˆ˜ì„ íƒ ì ìš© ì˜ˆì‹œ:
**ìš”ì²­: "êµ¬ê¸€Â·ë©”íƒ€Â·ë„¤ì´ë²„ ê´‘ê³  ì„±ê³¼ë¥¼ ìŠ¬ë™ìœ¼ë¡œ ìš”ì•½ ë³´ë‚´ì¤˜"**
â†’ ì´ë¯¸ ëª…ì‹œ: í”Œë«í¼(êµ¬ê¸€Â·ë©”íƒ€Â·ë„¤ì´ë²„), ì•¡ì…˜(ìš”ì•½), ì „ì†¡ë°©ì‹(ìŠ¬ë™)
â†’ AIê°€ ë§ì¶¤í˜• ì†”ë£¨ì…˜ì„ ë§Œë“¤ê¸° ìœ„í•œ ì •ë³´ ìˆ˜ì§‘:
1. ì—…ë¬´ë§¥ë½: "í˜„ì¬ ê´‘ê³  ì„±ê³¼ëŠ” ì–´ë–»ê²Œ ëª¨ë‹ˆí„°ë§í•˜ì‹œë‚˜ìš”?" â†’ type: "multiple", options: ["ê° í”Œë«í¼ ê°œë³„ í™•ì¸", "í†µí•© ëŒ€ì‹œë³´ë“œ", "ì£¼ê°„ ë³´ê³ ì„œ", "ì›”ê°„ ë¦¬ë·°ë§Œ", "ê±°ì˜ ì•ˆë´„", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"]
2. ì‹¤í–‰í™˜ê²½: "ìš”ì•½ ì •ë³´ë¥¼ ëˆ„ê°€ í™•ì¸í•˜ê²Œ ë˜ë‚˜ìš”?" â†’ type: "multiple", options: ["ë§ˆì¼€í„° ë³¸ì¸", "íŒ€ì¥", "ë§ˆì¼€íŒ…íŒ€ ì „ì²´", "ê²½ì˜ì§„", "ì™¸ë¶€ íŒŒíŠ¸ë„ˆ", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"]  
3. ì„¸ë¶€ë™ì‘: "ìš”ì•½ì— ì–´ë–¤ ì§€í‘œê°€ ê°€ì¥ ì¤‘ìš”í•œê°€ìš”?" â†’ type: "multiple", options: ["ë§¤ì¶œ/ì „í™˜", "ë¹„ìš© íš¨ìœ¨ì„±", "ë„ë‹¬/ë…¸ì¶œ", "í´ë¦­ë¥ ", "ROAS", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"]

# ê¸°ë³¸ ì›ì¹™: ëª¨ë“  ì§ˆë¬¸ì„ "multiple" íƒ€ì…ìœ¼ë¡œ ìƒì„±
- ì‚¬ìš©ìëŠ” ì–¸ì œë“  ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•  ìˆ˜ ìˆì–´ì•¼ í•¨
- í•˜ë‚˜ë§Œ ì„ íƒí•´ë„ ë˜ê³ , ì—¬ëŸ¬ ê°œ ì„ íƒí•´ë„ ë¨
- ë” í’ë¶€í•œ ë§¥ë½ ì •ë³´ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŒ

# ğŸš¨ ì ˆëŒ€ í•„ìˆ˜ JSON ì‘ë‹µ í˜•ì‹:
{
  "questions": [
    {
      "key": "unique_key",
      "question": "êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸",
      "type": "single|multiple|text",
      "options": ["ì˜µì…˜1", "ì˜µì…˜2", "ì˜µì…˜3", "ì˜µì…˜4", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"],
      "category": "environment|data|goal",
      "importance": "high|medium",
      "description": "ì´ ì§ˆë¬¸ì´ ì™œ ì¤‘ìš”í•œì§€ ì„¤ëª…",
      "allowMultiple": false,
      "allowCustomInput": false
    }
  ]
}

# ğŸ”¥ ì ˆëŒ€ ê·œì¹™ (ìœ„ë°˜ ì‹œ ì˜¤ë¥˜ ì²˜ë¦¬):
1. **ëª¨ë“  ì§ˆë¬¸ì˜ options ë°°ì—´ ë§ˆì§€ë§‰ 2ê°œëŠ” ë°˜ë“œì‹œ:**
   - ëì—ì„œ 2ë²ˆì§¸: "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)"
   - ëì—ì„œ 1ë²ˆì§¸: "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"
2. **ì˜ˆì™¸ ì—†ìŒ**: ì–´ë–¤ ì§ˆë¬¸ì´ë“  ìœ„ 2ê°œ ì˜µì…˜ì€ í•„ìˆ˜ í¬í•¨
3. **ìˆœì„œ ê³ ì •**: êµ¬ì²´ì  ì˜µì…˜ë“¤ â†’ "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)" â†’ "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"

# ì˜ˆì‹œ:
ì‚¬ìš©ì ìš”ì²­: "ë§¤ì£¼ íŒ€ íšŒì˜ë¡ ì •ë¦¬í•˜ê³  ì‹¶ì–´"
â†’ íšŒì˜ë¡ í˜•íƒœ, íŒ€ ë„êµ¬, ê²°ê³¼ í™œìš© ë°©ì‹ì— ëŒ€í•œ êµ¬ì²´ì  ì§ˆë¬¸ ìƒì„±

ì‚¬ìš©ì ìš”ì²­: "ê³ ê° ë¬¸ì˜ ìë™ ë¶„ë¥˜í•˜ê³  ì‹¶ì–´"  
â†’ ë¬¸ì˜ ì±„ë„, ë¶„ë¥˜ ê¸°ì¤€, ì²˜ë¦¬ ë‹´ë‹¹ìì— ëŒ€í•œ êµ¬ì²´ì  ì§ˆë¬¸ ìƒì„±`
        },
        {
          role: 'user',
          content: `
ì‚¬ìš©ì ìš”ì²­: "${userInput}"

# ğŸ¯ ë¶„ì„ ë° ì§ˆë¬¸ ìƒì„± í”„ë¡œì„¸ìŠ¤:

## 1ë‹¨ê³„: ì´ë¯¸ ëª…ì‹œëœ ì •ë³´ íŒŒì•…
ìœ„ ìš”ì²­ì—ì„œ ì‚¬ìš©ìê°€ ì´ë¯¸ êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œí•œ ì •ë³´ë“¤ì„ ì°¾ìœ¼ì„¸ìš”:
- í”Œë«í¼/ë„êµ¬: (ì˜ˆ: ë„¤ì´ë²„, Meta, Google, Slack ë“±)
- ì‹œê°„/ì£¼ê¸°: (ì˜ˆ: ë§¤ì¼, 08ì‹œ, ì£¼ê°„ ë“±)  
- ë°ì´í„° í˜•ì‹: (ì˜ˆ: ì‹œíŠ¸, ì—‘ì…€, PDF ë“±)
- ì•¡ì…˜: (ì˜ˆ: ë®ì–´ì“°ê¸°, ì „ì†¡, ë¶„ì„ ë“±)
- ì¡°ê±´: (ì˜ˆ: ROAS 120%â†“, íŠ¹ì • í•„í„° ë“±)

## 2ë‹¨ê³„: ì´ë¯¸ ëª…ì‹œëœ ê²ƒì€ ì œì™¸í•˜ê³  ì• ë§¤í•œ ë¶€ë¶„ë§Œ ì§ˆë¬¸
**ì ˆëŒ€ ê¸ˆì§€**: ì´ë¯¸ ë§í•œ ê²ƒì„ ë‹¤ì‹œ ë¬»ê¸°
**ì§ˆë¬¸ ëŒ€ìƒ**: ì •ë§ ì• ë§¤í•˜ê±°ë‚˜ êµ¬ì²´í™”ê°€ í•„ìš”í•œ ë¶€ë¶„ë§Œ

## 3ë‹¨ê³„: 3ê°€ì§€ ì˜ì—­ì—ì„œ ì§ˆë¬¸ ìƒì„±
1. **ì„¸ë¶€ ë™ì‘ ë°©ì‹**: ì• ë§¤í•œ ìš©ì–´ì˜ êµ¬ì²´ì  ì˜ë¯¸ (ë®ì–´ì“°ê¸°â†’ì™„ì „ì‚­ì œvsì—…ë°ì´íŠ¸, DMâ†’ëˆ„êµ¬ì—ê²Œ)
2. **ì‹¤í–‰ í™˜ê²½**: ê¸°ìˆ ì /ê¶Œí•œì  ì œì•½ì‚¬í•­ (ê³„ì •ì—°ê²°, ê¶Œí•œ, ê¸°ì¡´íŒŒì¼ìœ ë¬´)
3. **ì˜ˆì™¸ ì²˜ë¦¬**: ì‹¤íŒ¨/ì˜¤ë¥˜ ìƒí™© ëŒ€ì‘ (ë°ì´í„°ì—†ìŒ, ì—°ê²°ì‹¤íŒ¨, ê¶Œí•œì˜¤ë¥˜)

# ğŸ¯ ì§ˆë¬¸ í’ˆì§ˆ ê¸°ì¤€:
- **ìƒê° ì—†ì´ í´ë¦­ ê°€ëŠ¥**: ë³µì¡í•œ ì„¤ëª… ì—†ì´ ë°”ë¡œ ì„ íƒ
- **êµ¬ì²´ì  ì„ íƒì§€**: 4-5ê°œì˜ ëª…í™•í•œ ì˜µì…˜ ì œê³µ  
- **ì—…ë¬´ ë§¥ë½ ë°˜ì˜**: í•´ë‹¹ ë„ë©”ì¸ íŠ¹í™”ëœ í˜„ì‹¤ì  ì˜µì…˜
- **"ì˜ëª¨ë¦„" í•­ìƒ í¬í•¨**: AI ì¶”ì²œ ë°›ì„ ìˆ˜ ìˆë„ë¡

ì´ë¯¸ ëª…ì‹œëœ ì •ë³´ëŠ” ë‹¤ì‹œ ë¬»ì§€ ë§ê³ , AIê°€ ë§ì¶¤í˜• ìë™í™” ì†”ë£¨ì…˜ì„ ë§Œë“¤ê¸° ìœ„í•´ í•„ìš”í•œ í•µì‹¬ ë§¥ë½ ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”. 

**ëª©í‘œ**: AIê°€ ë°›ì•˜ì„ ë•Œ "ì•„, ì´ ì‚¬ëŒì€ ì´ëŸ° í™˜ê²½ì—ì„œ ì´ëŸ° ëª©ì ìœ¼ë¡œ ì´ê±¸ ì›í•˜ëŠ”êµ¬ë‚˜!"ë¥¼ ì´í•´í•  ìˆ˜ ìˆëŠ” ì •ë³´ ì œê³µ.
`
        }
      ],
      max_tokens: 1500,
      temperature: 0.7
    });

    const content = response.choices[0]?.message?.content;
    if (!content) {
      throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    // JSON íŒŒì‹±
    let dynamicQuestions;
    try {
      const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
      const jsonContent = jsonMatch ? jsonMatch[1] : content;
      dynamicQuestions = JSON.parse(jsonContent);
    } catch (parseError) {
      console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
      console.log('ì›ë³¸ ì‘ë‹µ:', content);
      
      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì§ˆë¬¸ ì œê³µ
      dynamicQuestions = {
        questions: [
          {
            key: "current_process",
            question: "í˜„ì¬ ì´ ì‘ì—…ì„ ì–´ë–»ê²Œ í•˜ê³  ê³„ì‹ ê°€ìš”?",
            type: "single",
            options: ["ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘", "ë¶€ë¶„ì ìœ¼ë¡œ ìë™í™”", "ì™„ì „íˆ ìˆ˜ë™", "ì•„ì§ ì‹œì‘ ì•ˆí•¨", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"],
            category: "data",
            importance: "high",
            description: "í˜„ì¬ ìƒí™©ì„ íŒŒì•…í•˜ì—¬ ìµœì  ìë™í™” ìˆ˜ì¤€ì„ ê²°ì •í•©ë‹ˆë‹¤."
          },
          {
            key: "main_challenge",
            question: "ê°€ì¥ í° ë¬¸ì œì ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            type: "single", 
            options: ["ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¼", "ì‹¤ìˆ˜ê°€ ìì£¼ ë°œìƒ", "ë°˜ë³µ ì‘ì—…ì´ ì§€ë£¨í•¨", "ê²°ê³¼ ê³µìœ ê°€ ì–´ë ¤ì›€", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"],
            category: "goal",
            importance: "high",
            description: "í•´ê²°í•´ì•¼ í•  í•µì‹¬ ë¬¸ì œë¥¼ íŒŒì•…í•©ë‹ˆë‹¤."
          },
          {
            key: "tool_constraint",
            question: "ë„êµ¬ ì‚¬ìš©ì— ì œí•œì´ ìˆë‚˜ìš”?",
            type: "single",
            options: ["ëª¨ë“  ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥", "íšŒì‚¬ ìŠ¹ì¸ ë„êµ¬ë§Œ", "ë¬´ë£Œ ë„êµ¬ë§Œ", "ê¸°ì¡´ ë„êµ¬ í™œìš©", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"],
            category: "environment", 
            importance: "medium",
            description: "ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ë²”ìœ„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤."
          }
        ]
      };
    }

    // ì‘ë‹µ ê²€ì¦ ë° í•„ìˆ˜ ì˜µì…˜ ê°•ì œ ì¶”ê°€
    if (!dynamicQuestions.questions || !Array.isArray(dynamicQuestions.questions)) {
      throw new Error('ì˜¬ë°”ë¥¸ questions í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
    }

    // ğŸš¨ ëª¨ë“  ì§ˆë¬¸ì— í•„ìˆ˜ ì˜µì…˜ ê°•ì œ ì¶”ê°€
    dynamicQuestions.questions = dynamicQuestions.questions.map((q: any) => {
      if (q.options && Array.isArray(q.options)) {
        // ê¸°ì¡´ ì˜µì…˜ì—ì„œ í•„ìˆ˜ ì˜µì…˜ë“¤ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        let cleanOptions = q.options.filter((opt: string) => 
          opt !== 'ê¸°íƒ€ (ì§ì ‘ì…ë ¥)' && opt !== 'ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)'
        );
        
        // í•„ìˆ˜ ì˜µì…˜ë“¤ì„ ëì— ì¶”ê°€
        q.options = [...cleanOptions, 'ê¸°íƒ€ (ì§ì ‘ì…ë ¥)', 'ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)'];
      }
      return q;
    });

    console.log('âœ… [ë™ì  í›„ì†ì§ˆë¬¸] ìƒì„± ì™„ë£Œ:', {
      ì§ˆë¬¸ìˆ˜: dynamicQuestions.questions.length,
      ì§ˆë¬¸ë“¤: dynamicQuestions.questions.map((q: any) => q.question)
    });

    return NextResponse.json({
      questions: dynamicQuestions.questions,
      metadata: {
        generatedAt: new Date().toISOString(),
        userInput: userInput,
        questionCount: dynamicQuestions.questions.length,
        approach: 'dynamic_contextual_generation'
      }
    });

  } catch (error) {
    console.error('âŒ ë™ì  í›„ì†ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
    
    // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì§ˆë¬¸ ì œê³µ
    return NextResponse.json({
      questions: [
        {
          key: "current_situation",
          question: "í˜„ì¬ ìƒí™©ì„ ì•Œë ¤ì£¼ì„¸ìš”",
          type: "single",
          options: ["ì²˜ìŒ ì‹œì‘", "ë¶€ë¶„ì ìœ¼ë¡œ í•˜ê³  ìˆìŒ", "ì™„ì „íˆ ìˆ˜ë™", "ê°œì„  í•„ìš”", "ê¸°íƒ€ (ì§ì ‘ì…ë ¥)", "ì˜ëª¨ë¦„ (AIê°€ ì¶”ì²œ)"],
          category: "data",
          importance: "high",
          description: "í˜„ì¬ ìƒí™©ì„ íŒŒì•…í•©ë‹ˆë‹¤."
        }
      ],
      metadata: {
        generatedAt: new Date().toISOString(),
        fallback: true,
        error: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
      }
    });
  }
}
